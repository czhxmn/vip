/**
 * @fileoverview 文件上传验证
 * @author: 剑平（明河）<minghe36@126.com>
 **/KISSY.add("gallery/form/1.2/uploader/auth/base",function(e,t,n){function u(t,n){var r=this;n=e.merge({uploader:t},n),u.superclass.constructor.call(r,n),r._init()}var r="",i=t.all,s=s||e,o="[uploader-auth]:";return e.mix(u,{event:{ERROR:"error"}}),e.extend(u,n,{_init:function(){var e=this,t=e.get("uploader"),n=t.get("queue");if(t==r)return s.log(o+"uploader\u4e0d\u53ef\u4ee5\u4e3a\u7a7a\uff01"),!1;e._setSwfButtonExt(),n.on("add",function(t){var n=t.file;e.testAllowExt(n),e.testMaxSize(n),e.testRepeat(n)}),n.on("remove",function(t){var n=t.file,r=n.status;r=="success"&&e.testMax()}),n.on("statusChange",function(n){var r=n.status;r=="start"&&t.get("disabled")&&e._maxStopUpload(),r=="success"&&e.testMax()}),t.on("error",function(e){t.set("isAllowUpload",!0)})},testAll:function(){var e=this;return e.testRequire()&&e.testMax()},getRule:function(e){var t=this,n=t.get("rules");return n[e]},isUploaderType:function(e){var t=this,n=t.get("uploader"),r=n.get("type");return e==r},testRequire:function(){var t=this,n=t.get("uploader"),r=n.get("urlsInput"),i=r.get("urls"),s=t.getRule("require"),u=s?s[0]:!1,a=i.length>0;return u?(a||(e.log(o+s[1]),t._fireUploaderError("require",s)),a):!0},testAllowExt:function(t){function f(t){var n=!1,r;return e.each(s,function(e){r=new RegExp("^.+."+e+"$");if(r.test(t))return n=!0}),n}function l(e){var t=e.split(".");return t[t.length-1]}if(!e.isObject(t))return!1;var n=this,r=t.name,i=n.getRule("allowExts"),s=[],o,u,a;return e.isArray(i)?(s=n._getExts(i[0].ext),a=f(r),a||(o=l(r),u=e.substitute(i[1],{ext:o}),n._fireUploaderError("allowExts",[i[0],u],t)),a):!1},testMax:function(){var t=this,n=t.get("uploader"),r=n.get("queue"),i=r.getFiles("success"),s=i.length,o=t.getRule("max"),u;if(o){var a=s<o[0];return a?(n.set("disabled",!1),n.set("isAllowUpload",!0)):(n.set("disabled",!0),n.set("isAllowUpload",!1),u=e.substitute(o[1],{max:o[0]}),t._fireUploaderError("max",[o[0],u])),a}},testMaxSize:function(t){var n=this,r=t.size,i=n.getRule("maxSize");if(i){var s=Number(i[0])*1024,o=r<=s,u;return o||(u=e.substitute(i[1],{maxSize:e.convertByteSize(s),size:t.textSize}),n._fireUploaderError("maxSize",[i[0],u],t)),o}},testRepeat:function(t){if(!e.isObject(t))return!1;var n=this,r=t.name,i=n.getRule("allowRepeat");if(i){var s=i[0],o=n.get("uploader"),u=o.get("queue"),a=u.getFiles("success"),f=!1;return s?!1:(e.each(a,function(e){if(e.name==r)return n._fireUploaderError("allowRepeat",i,t),f=!0}),f)}},_setSwfButtonExt:function(){var t=this,n=t.get("uploader"),r=t.getRule("allowExts"),i=n.get("button"),s=t.isUploaderType("flash");return!s||!e.isArray(r)?!1:(i.set("fileFilters",r[0]),t)},_getExts:function(t){if(!e.isString(t))return!1;var n=t.split(";"),r=[],i=/^\*\./;return e.each(n,function(e){e=e.replace(i,""),r.push(e.toUpperCase())}),e.each(r,function(e){n.push(e)}),n},_fireUploaderError:function(t,n,r){var i=this,s=i.get("uploader"),o=s.get("queue"),a={status:-1,rule:t},f=-1;r&&(e.mix(a,{file:r}),f=o.getFileIndex(a.file.id)),n&&e.mix(a,{msg:n[1],value:n[0],result:{}}),o.fileStatus(f,"error",a),i.fire(u.event.ERROR,a),s.fire("error",a)},_maxStopUpload:function(){var t=this,n=t.get("uploader"),r=n.get("queue"),i=n.get("curUploadIndex"),s=r.get("files");n.stop(),e.each(s,function(e,t){t>=i&&r.remove(e.id)})}},{ATTRS:{uploader:{value:r},rules:{value:{allowExts:[{desc:"JPG,JPEG,PNG,GIF,BMP",ext:"*.jpg;*.jpeg;*.png;*.gif;*.bmp"},"\u4e0d\u652f\u6301{ext}\u683c\u5f0f\u7684\u6587\u4ef6\u4e0a\u4f20\uff01"],require:[!1,"\u5fc5\u987b\u81f3\u5c11\u4e0a\u4f20\u4e00\u4e2a\u6587\u4ef6\uff01"],max:[3,"\u6bcf\u6b21\u6700\u591a\u4e0a\u4f20{max}\u4e2a\u6587\u4ef6\uff01"],maxSize:[1e3,"\u6587\u4ef6\u5927\u5c0f\u4e3a{size}\uff0c\u6587\u4ef6\u592a\u5927\uff01"],allowRepeat:[!1,"\u8be5\u6587\u4ef6\u5df2\u7ecf\u5b58\u5728\uff01"]}}}}),u},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/base",function(e,t,n,r,i,s,o,u,a,f){function p(e){var t=this;p.superclass.constructor.call(t,e)}var l="",c=n.all,h="[uploader]:";return e.mix(p,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{RENDER:"render",SELECT:"select",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"}}),e.extend(p,t,{render:function(){var t=this,n=t.get("serverConfig"),r=t.get("type"),i=t.getUploadType(r),s,o=i.event,u;return i?(u=t._renderButton(),t.set("urlsInput",t._renderUrlsInput()),t._renderQueue(),t.get("type")==p.type.FLASH&&e.mix(n,{swfUploader:u.get("swfUploader")}),s=new i(n),s.on(o.SUCCESS,t._uploadCompleteHanlder,t),o.PROGRESS&&s.on(o.PROGRESS,t._uploadProgressHandler,t),s.on(o.STOP,t._uploadStopHanlder,t),t.set("uploadType",s),t.fire(p.event.RENDER),t):!1},upload:function(t){if(!e.isNumber(t))return!1;var n=this,r=n.get("uploadType"),i=n.get("type"),s=n.get("queue"),o=s.get("files")[t],u;if(!e.isPlainObject(o))return e.log(h+"\u961f\u5217\u4e2d\u4e0d\u5b58\u5728id\u4e3a"+t+"\u7684\u6587\u4ef6"),!1;if(n.get("curUploadIndex")!=l)return alert("\u7b2c"+n.get("curUploadIndex")+"\u6587\u4ef6\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u4e0a\u4f20\u5b8c\u540e\u518d\u64cd\u4f5c\uff01"),!1;u=o.input.id||o.input,i=="ajax"&&(u=o.data);if(o.status==="error")return!1;n.fire(p.event.START,{index:t,file:o});if(!n.get("isAllowUpload"))return!1;n.set("curUploadIndex",t),s.fileStatus(t,p.status.START),r.upload(u)},cancel:function(t){var n=this,r=n.get("uploadType"),i=n.get("queue"),s=p.status,o=i.fileStatus(t);return e.isNumber(t)&&o!=s.SUCCESS?(r.stop(),i.fileStatus(t,s.CANCEL)):(r.stop(),n._continueUpload()),n},stop:function(){var e=this;return e.set("uploadFilesStatus",l),e.cancel(),e},uploadFiles:function(t){var n=this;return e.isString(t)||(t=p.status.WAITING),n.set("uploadFilesStatus",t),n._uploaderStatusFile(t),n},_uploaderStatusFile:function(e){var t=this,n=t.get("queue"),r=n.getIndexs(e);return r.length?(t.upload(r[0]),t):(t.set("uploadFilesStatus",l),t.fire(p.event.UPLOAD_FILES),!1)},isSupportAjax:function(){var e=!1;try{FormData&&(e=!0)}catch(t){e=!1}return e},isSupportFlash:function(){var t=e.UA.fpv();return e.isArray(t)&&t.length>0},getUploadType:function(t){var n=this,r=p.type,i;return t==r.AUTO&&(t=[r.AJAX,r.FLASH,r.IFRAME]),e.isArray(t)&&t.length>0?e.each(t,function(e){i=n._getType(e);if(i)return!1}):i=n._getType(t),i},_getType:function(t){var n=this,r=p.type,u,a=n.isSupportAjax(),f=n.isSupportFlash();switch(t){case r.IFRAME:u=i;break;case r.AJAX:u=a&&s||!1;break;case r.FLASH:u=f&&o||!1;break;default:return e.log(h+"type\u53c2\u6570\u4e0d\u5408\u6cd5"),!1}return u&&e.log(h+"\u4f7f\u7528"+t+"\u4e0a\u4f20\u65b9\u5f0f"),n.set("type",t),u},_renderButton:function(){var t=this,n,r,i=t.get("type"),s=t.get("target"),o=t.get("multiple"),f=t.get("disabled"),l=t.get("name"),c={name:l,multiple:o,disabled:f};return i==p.type.FLASH?(r=a,e.mix(c,{size:t.get("swfSize")})):r=u,n=new r(s,c),n.on("change",t._select,t),n.render(),t.set("button",n),n},_renderQueue:function(){var t=this,n=new f,r=t.get("urlsInput");return e.isObject(n)?(n.set("uploader",t),n.on("remove",function(e){e.file.sUrl&&r&&r.remove(e.file.sUrl)}),t.set("queue",n),n):(e.log(h+"queue\u53c2\u6570\u4e0d\u5408\u6cd5"),!1)},_select:function(t){var n=this,r=n.get("autoUpload"),i=n.get("queue"),s=n.get("curUploadIndex"),o=t.files;e.each(o,function(e){e.size||(e.size=0),e.name||(e.name=e.fileName||l),e.input=t.input||e}),o=n._processExceedMultiple(o),n.fire(p.event.SELECT,{files:o});if(!n.get("isAllowUpload"))return!1;i.add(o,function(){s==l&&r&&n.uploadFiles()})},_processExceedMultiple:function(t){var n=this,r=n.get("multipleLen");return r<0||!e.isArray(t)||!t.length?t:e.filter(t,function(e,t){return t<r})},_renderUrlsInput:function(){var e=this,t=e.get("button"),n=t.get("target"),i=e.get("urlsInputName"),s=new r(n,{name:i});return s.render(),s},_uploadCompleteHanlder:function(t){var n=this,r=t.result,i,s=p.event,o=n.get("queue"),u=n.get("curUploadIndex");if(!e.isObject(r))return!1;o.updateFile(u,{result:r}),i=Number(r.status);if(i===1)o.fileStatus(u,p.status.SUCCESS),n._success(r.data),n.fire(s.SUCCESS,{index:u,file:o.getFile(u),result:r});else{var a=r.msg||r.message||l;o.fileStatus(u,p.status.ERROR,{msg:a,result:r}),n.fire(s.ERROR,{status:i,result:r,index:u,file:o.getFile(u)})}n.set("curUploadIndex",l),n.fire(s.COMPLETE,{index:u,file:o.getFile(u),result:r}),n._continueUpload()},_uploadStopHanlder:function(){var e=this,t=e.get("queue"),n=e.get("curUploadIndex");t.fileStatus(n,p.status.CANCEL),e.set("curUploadIndex",l),e.fire(p.event.CANCEL,{index:n})},_continueUpload:function(){var e=this,t=e.get("uploadFilesStatus");t!=l&&e._uploaderStatusFile(t)},_uploadProgressHandler:function(t){var n=this,r=n.get("queue"),i=n.get("curUploadIndex"),s=r.getFile(i);e.mix(t,{file:s}),r.fileStatus(i,p.status.PROGRESS,t),n.fire(p.event.PROGRESS,t)},_success:function(t){if(!e.isObject(t))return!1;var n=this,r=t.url,i=n.get("urlsInput"),s=n.get("curUploadIndex"),o=n.get("queue");if(!e.isString(r)||!e.isObject(i))return!1;o.updateFile(s,{sUrl:r}),i.add(r)},restore:function(t){var n=this,r=n.get("queue"),i=n.get("urlsInput");t||(t=n._getRestoreData());if(!t.length)return!1;e.each(t,function(e){!e.sUrl&&e.result&&(e.sUrl=e.result.data.url);var t=r.add(e),n=t.id,s=r.getFileIndex(n);i.add(e.sUrl),r.fileStatus(s,"success",{index:s,id:n,file:t})}),e.later(function(){n.fire(p.event.RESTORE,{files:r.get("files")})},500)},_getRestoreData:function(){var t=this,n=t.get("restoreHook"),r=c(n);return r.length?e.JSON.parse(e.trim(r.html())):[]}},{ATTRS:{button:{value:{}},queue:{value:{}},type:{value:p.type.AUTO},multiple:{value:!0,setter:function(t){var n=this,r=n.get("button");return!e.isEmptyObject(r)&&e.isBoolean(t)&&r.set("multiple",t),t}},multipleLen:{value:-1},disabled:{value:!1,setter:function(t){var n=this,r=n.get("button");return!e.isEmptyObject(r)&&e.isBoolean(t)&&r.set("disabled",t),t}},serverConfig:{value:{action:l,data:{},dataType:"json"}},data:{value:{},getter:function(){var e=this,t=e.get("uploadType"),n=e.get("serverConfig").data||{};return t&&(n=t.get("data")),n},setter:function(t){if(e.isObject(t)){var n=this,r=n.get("uploadType");r&&(r.set("data",t),n.set("serverConfig",e.mix(n.get("serverConfig"),{data:t})))}return t}},isAllowUpload:{value:!0},autoUpload:{value:!0},urlsInputName:{value:l},curUploadIndex:{value:l},uploadType:{value:{}},urlsInput:{value:l},uploadFilesStatus:{value:l},restoreHook:{value:l},swfSize:{value:{}}}}),e.convertByteSize=function(e){var t=-1;do e/=1024,t++;while(e>99);return Math.max(e,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][t]},p},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax","./type/flash","./button/base","./button/swfButton","./queue"]}),KISSY.add("gallery/form/1.2/uploader/button/base",function(e,t,n){function o(t,n){var r=this;n=e.merge({target:s(t)},n),o.superclass.constructor.call(r,n)}var r="",i="[Uploader-Button] ",s=t.all;return e.mix(o,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(e){return e.replace(/.*(\/|\\)/,"")}}),e.extend(o,n,{render:function(){var t=this,n=t.get("target"),r=t.fire(o.event.beforeRender);return r===!1?(e.log(i+"button render was prevented."),!1):n==null?(e.log(i+"Cannot find target!"),!1):(t._createInput(),t.fire(o.event.afterRender),t)},show:function(){var e=this,t=e.get("target");return t.show(),e.fire(o.event.afterShow),o},hide:function(){var e=this,t=e.get("target");return t.hide(),e.fire(o.event.afterHide),o},reset:function(){var e=this,t=e.get("inputContainer");return s(t).remove(),e.set("inputContainer",r),e.set("fileInput",r),e._createInput(),e},_createInput:function(){var t=this,n=t.get("target"),r=t.get("name"),o=t.get("tpl"),u,a,f;return!e.isString(r)||!e.isString(o)?(e.log(i+"No name or tpl specified."),!1):(u=e.substitute(o,{name:r}),a=s(u),s(a).appendTo(n),f=s(a).children("input"),e.UA.ie==6&&f.css("fontSize","400px"),s(f).on("change",t._changeHandler,t),t.set("fileInput",f),t.set("inputContainer",a),t._setDisabled(t.get("disabled")),t._setMultiple(t.get("multiple")),a)},_changeHandler:function(t){var n=this,u=n.get("fileInput"),a=s(u).val(),f=t.target.files,l=[];if(a==r)return e.log(i+"No file selected."),!1;f?e.each(f,function(t){e.isObject(t)&&l.push({name:t.name,type:t.type,size:t.size,data:t})}):l.push({name:o.getFileName(a)}),n.fire(o.event.CHANGE,{files:l,input:u.getDOMNode()}),n.reset()},_setDisabled:function(t){var n=this,r=n.get("cls"),i=r.disabled,o=n.get("target"),u=n.get("fileInput");return!o.length||!e.isBoolean(t)?!1:(t?(o.addClass(i),s(u).hide()):(o.removeClass(i),s(u).show()),t)},_setMultiple:function(e){var t=this,n=t.get("fileInput");return n.length?(e&&n.attr("multiple","multiple")||n.removeAttr("multiple"),e):!1}},{ATTRS:{target:{value:null},fileInput:{value:r},inputContainer:{value:r},tpl:{value:'<div class="file-input-wrapper" style="overflow: hidden;"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(e){return this.get("fileInput")&&s(this.get("fileInput")).attr("name",e),e}},disabled:{value:!1,setter:function(e){return this._setDisabled(e),e}},multiple:{value:!0,setter:function(e){return this._setMultiple(e),e}},cls:{value:{disabled:"uploader-button-disabled"}}}}),o},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/button/swfButton",function(e,t,n,r){function u(t,n){var r=this;n=e.merge({target:s(t)},n),u.superclass.constructor.call(r,n)}var i="",s=t.all,o="swf-uploader-wrapper-";return e.mix(u,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}}),e.extend(u,n,{render:function(){var e=this,t=e.get("target"),n,r=e.get("multiple"),i=e.get("fileFilters");t.css("position","relative"),e.set("swfWrapper",e._createSwfWrapper()),e._setFlashSizeConfig(),n=e._initSwfUploader(),n.on("contentReady",function(t){n.browse(r,i),e._bindBtnEvent(),n.on("fileSelect",e._changeHandler,e),e._setDisabled(e.get("disabled")),e.fire(u.event.RENDER)},e)},_createSwfWrapper:function(){var t=this,n=t.get("target"),r=t.get("tpl"),u=t.get("swfWrapperId")!=i&&t.get("swfWrapperId")||o+e.guid(),a=e.substitute(r,{id:u});return t.set("swfWrapperId",u),s(a).appendTo(n)},_initSwfUploader:function(){var t=this,n=t.get("flash"),i=t.get("swfWrapperId"),s;e.mix(n,{id:"swfUploader"+e.guid()});try{s=new r(i,n),t.set("swfUploader",s)}catch(o){}return s},_bindBtnEvent:function(){var t=this,n=u.event,r=t.get("swfUploader");return r?(e.each(n,function(e){r.on(e,function(n){t.fire(e)},t)}),t):!1},_setFlashSizeConfig:function(){var t=this,n=t.get("flash"),r=t.get("target"),i=t.get("size");e.isEmptyObject(i)?e.mix(n.attrs,{width:r.innerWidth(),height:r.innerHeight()}):e.mix(n.attrs,i),t.set("flash",n)},_changeHandler:function(e){var t=this,n=e.fileList;t.fire(u.event.CHANGE,{files:n})},_setDisabled:function(t){var n=this,r=n.get("swfUploader"),i=n.get("cls"),s=i.disabled,o=n.get("target"),u=n.get("swfWrapper");return!r||!e.isBoolean(t)?!1:(t?(o.addClass(s),u.css("top","-3000px")):(o.removeClass(s),u.css("top",0)),t)},show:function(){var e=this,t=e.get("target");t.show()},hide:function(){var e=this,t=e.get("target");t.hide()}},{ATTRS:{target:{value:i},swfWrapper:{value:i},swfWrapperId:{value:i},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;z-index:2000;"></div>'},multiple:{value:!0,setter:function(e){var t=this,n=t.get("swfUploader");return n&&n.multifile(e),e}},fileFilters:{value:[],setter:function(t){var n=this,r=n.get("swfUploader");return e.isObject(t)&&(t=[t]),r&&e.isArray(t)&&e.later(function(){r.filter(t)},800),t}},disabled:{value:!1,setter:function(e){var t=this,n=t.get("swfUploader");return n&&t._setDisabled(e),e}},cls:{value:{disabled:"uploader-button-disabled"}},size:{value:{}},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/form/1.2/uploader/plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:!0,btn:!0}},swfUploader:{value:i}}}),u},{requires:["node","base","../plugins/ajbridge/uploader"]}),KISSY.add("gallery/form/1.2/uploader/index",function(e,t,n,r,i){function c(t,n,r){var i=this;r=e.mix(e.form.parseConfig(t),r),c.superclass.constructor.call(i,r),i.set("buttonTarget",t),i.set("queueTarget",n),i.set("uploaderConfig",r),i._init()}var s="",o=n.all,u="[uploaderRender]:",a={CONFIG:"data-config",BUTTON_CONFIG:"data-button-config",THEME_CONFIG:"data-theme-config",AUTH:"data-auth"},f=["default","imageUploader","ershouUploader","uploadify"],l="gallery/form/1.2/uploader/themes/";return e.namespace("form"),e.form.parseConfig=function(t,n){var r={},i,s=n||a.CONFIG;i=o(t).attr(s);if(!e.isString(i))return{};try{r=e.JSON.parse(i)}catch(f){e.log(u+"\u8bf7\u68c0\u67e5"+t+"\u4e0a"+s+"\u5c5e\u6027\u5185\u7684json\u683c\u5f0f\u662f\u5426\u7b26\u5408\u89c4\u8303\uff01")}return r},e.extend(c,t,{_init:function(){var t=this,n=t.get("theme"),r;n==s?(r=t._initUploader(),t.set("button",r.get("button")),e.later(function(){t.fire("init",{uploader:r,button:r.get("button"),queue:r.get("queue"),auth:r.get("auth")})},500)):t._initThemes(function(e){r=t._initUploader(),t.set("button",r.get("button")),e.set("uploader",r),e.set("button",r.get("button")),e.set("queue",r.get("queue")),e.set("auth",r.get("auth")),e._UploaderRender(function(){e.afterUploaderRender(r),r.restore(),t.fire("init",{uploader:r,button:r.get("button"),queue:r.get("queue"),auth:r.get("auth")})})})},_initUploader:function(){var t=this,n=t.get("uploaderConfig"),i=t.get("name");e.mix(n.serverConfig,{fileDataName:i}),e.mix(n,{target:t.get("buttonTarget")});var s=new r(n);return s.render(),t.set("uploader",s),t._auth(),s},_initThemes:function(t){var n=this,r=n.get("theme"),i=n.get("buttonTarget"),s=n.get("themeConfig"),o=e.form.parseConfig(i,a.THEME_CONFIG);e.mix(o,s),n.set("themeConfig",o),r=n._getThemeName(r),e.use(r,function(e,r){var i=n.get("queueTarget"),s;e.mix(o,{queueTarget:i,buttonTarget:n.get("buttonTarget")}),s=new r(o),s.on("render",function(){t&&t.call(n,s)}),s.render()})},_getThemeName:function(t){var n=t;return e.each(f,function(e){e==t&&(n=l+t)}),n+="/index",n},_auth:function(){var t=this,n=t.get("buttonTarget"),r=t.get("uploader"),s=t.get("authConfig"),o=e.form.parseConfig(n,a.AUTH);return e.mix(o,s),t.set("authConfig",o),e.isEmptyObject(o)?!1:(auth=new i(r,{rules:o}),r.set("auth",auth),auth)}},{ATTRS:{theme:{value:"default"},themeConfig:{value:{}},buttonTarget:{value:s},queueTarget:{value:s},uploaderConfig:{},authConfig:{value:{}},button:{value:s},queue:{value:s},uploader:{value:s}}}),c},{requires:["base","node","./base","./auth/base"]}),KISSY.add("gallery/form/1.2/uploader/plugins/ajbridge/ajbridge",function(e,t){function u(r,a,f){r=r.replace(n,""),a=t._normalize(a||{});var l=this,c=n+r,h=function(t){if(t.status<1){l.fire("failed",{data:t});return}e.mix(l,t),(!t.dynamic||!a.src)&&l.activate()};a.id=a.id||e.guid(i),u.instances[a.id]=l,a.src&&(a.params.allowscriptaccess="always",a.params.flashvars=e.merge(a.params.flashvars,{jsEntry:o,swfID:a.id})),f?l.__args=[c,a,h]:e.later(t.add,s,!1,t,[c,a,h])}var n="#",r="1.0.15",i="ks-ajb-",s=100,o="KISSY.AJBridge.eventHandler";return e.mix(u,{version:r,instances:{},eventHandler:function(e,t){var n=u.instances[e];n&&n.__eventHandler(e,t)},augment:function(t,n){e.isString(n)&&(n=[n]);if(!e.isArray(n))return;e.each(n,function(n){t.prototype[n]=function(){try{return this.callSWF(n,e.makeArray(arguments))}catch(t){this.fire("error",{message:t})}}})}}),e.augment(u,e.EventTarget,{init:function(){if(!this.__args)return;t.add.apply(t,this.__args),this.__args=null,delete this.__args},__eventHandler:function(t,n){var r=this,i=n.type;n.id=t;switch(i){case"log":e.log(n.message);break;default:r.fire(i,n)}},callSWF:function(e,t){var n=this;t=t||[];try{if(n.swf[e])return n.swf[e].apply(n.swf,t)}catch(r){var i="";return t.length!==0&&(i="'"+t.join("','")+"'"),(new Function("self","return self.swf."+e+"("+i+");"))(n)}}}),u.augment(u,["activate","getReady","getCoreVersion"]),window.AJBridge=e.AJBridge=u,u},{requires:["flash"]}),KISSY.add("gallery/form/1.2/uploader/plugins/ajbridge/uploader",function(e,t,n){function r(t,n){n=n||{};var i={};e.each(["ds","dsp","btn","hand"],function(e){e in n&&(i[e]=n[e])}),n.params=n.params||{},n.params.flashvars=e.merge(n.params.flashvars,i),r.superclass.constructor.call(this,t,n)}return e.extend(r,n),n.augment(r,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]),r.version="1.0.1",n.Uploader=r,n.Uploader},{requires:["flash","./ajbridge"]}),KISSY.add("gallery/form/1.2/uploader/plugins/filedrop/filedrop",function(e,t,n){var r="",i=t.all,s=e.UA,o=function(e){var t=this;o.superclass.constructor.call(t,e),t.set("mode",u())},u=function(){if(s.webkit>=7||s.firefox>=3.6)return"supportDrop";if(s.ie)return"notSupportDropIe";if(s.webkit<7||s.firefox<3.6)return"notSupportDrop"};return e.mix(o,{event:{AFTER_DROP:"afterdrop"}}),e.extend(o,n,{render:function(){var t=this,n=t.get("mode"),r=t.get("uploader"),i;if(r.get("type")=="flash")return e.log("flash\u4e0a\u4f20\u65b9\u5f0f\u4e0d\u652f\u6301\u62d6\u62fd\uff01"),t.set("isSupport",!1),!1;if(n!="supportDrop")return e.log("\u8be5\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u62d6\u62fd\u4e0a\u4f20\uff01"),t.set("isSupport",!1),!1;if(!r)return e.log("\u7f3a\u5c11Uploader\u7684\u5b9e\u4f8b\uff01"),!1;i=t._createDropArea(),i.length&&i.on("click",t._clickHandler,t),r.on("afterDisabledChange",function(e){t[e.newVal&&"hide"||"show"]()}),t.fire("afterRender",{buttonTarget:t.get("buttonWrap")})},show:function(){var e=this,t=e.get("dropContainer");t.show()},hide:function(){var e=this,t=e.get("dropContainer");t.hide()},reset:function(){},_createDropArea:function(){var t=this,n=i(t.get("target")),r=t.get("mode"),s=e.substitute(t.get("tpl")[r],{name:t.get("name")}),o=i(s),u=o.all(".J_ButtonWrap");return o.appendTo(n),o.on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),o.on("drop",function(e){e.stopPropagation(),e.preventDefault(),t._dropHandler(e)}),t.set("dropContainer",o),t.set("buttonWrap",u),t._setStyle(),o},_setStyle:function(){var e=this,t=e.get("dropContainer");if(!t.length)return!1;t.parent().css("position","relative"),t.css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"1000"})},_clickHandler:function(e){var t=this,n=i(e.target),r=t.get("uploader"),s=r.get("button"),o=s.get("fileInput");o.fire("click")},_dropHandler:function(t){var n=this,i=o.event,s=t.originalEvent.dataTransfer.files,u=[],a=n.get("uploader");if(!s.length||a==r)return!1;e.each(s,function(t){e.isObject(t)&&u.push({name:t.name,type:t.type,size:t.size,data:t})}),n.fire(i.AFTER_DROP,{files:u}),a._select({files:u})},_setDisabled:function(){}},{ATTRS:{target:{value:r},uploader:{value:r},dropContainer:{value:r},isSupport:{value:!0},tpl:{value:{supportDrop:'<div class="drop-wrapper"><p>\u76f4\u63a5\u62d6\u62fd\u56fe\u7247\u5230\u8fd9\u91cc\uff0c</p><p class="J_ButtonWrap">\u6216\u8005</p></div>',notSupportDropIe:'<div class="drop-wrapper"><p>\u60a8\u7684\u6d4f\u89c8\u5668\u53ea\u652f\u6301\u4f20\u7edf\u7684\u56fe\u7247\u4e0a\u4f20\uff0c</p><p class="suggest J_ButtonWrap">\u63a8\u8350\u4f7f\u7528chrome\u6d4f\u89c8\u5668\u6216firefox\u6d4f\u89c8\u5668</p></div>',notSupportDrop:'<div class="drop-wrapper"><p>\u60a8\u7684\u6d4f\u89c8\u5668\u53ea\u652f\u6301\u4f20\u7edf\u7684\u56fe\u7247\u4e0a\u4f20\uff0c</p><p class="suggest J_ButtonWrap">\u63a8\u8350\u5347\u7ea7\u60a8\u7684\u6d4f\u89c8\u5668</p></div>'}},name:{value:"",setter:function(e){}},disabled:{value:!1,setter:function(e){return this._setDisabled(e),e}},cls:{disabled:"drop-area-disabled"}}}),o},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/plugins/preview/preview",function(e,t,n){function a(){var t="";if(typeof window.FileReader=="undefined")switch(e.UA.shell){case"firefox":t="domfile";break;case"ie":switch(e.UA.ie){case 6:t="simple";break;default:t="filter"}}else t="html5";return t}function f(e,t,n,r){return e?(s!="filter"?e.src=t||u:(e.src=u,t&&(t=t.replace(/[)'"%]/g,function(e){return escape(escape(e))}),e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='"+t+"')",e.zoom=1)),!0):!1}function l(t){var n=this,r={maxWidth:40,maxHeight:40};n.config=e.mix(r,t),e.log(i+"Preview initialized. The preview mode is "+s)}var r=document,i="[Plugin: Preview] ",s=a(),o={check:"check",success:"success",showed:"showed",error:"error"},u=e.UA.ie<8?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";return e.augment(l,e.EventTarget,{preview:function(n,u){n=t.get(n),u=t.get(u);var a=this,l=function(){a.fire(o.getData,{data:a.data,mode:s}),u&&(f(u,a.data),a.fire(o.showed,{img:u}))};a.data=undefined;if(n){e.log(i+"One file selected. Getting data...");switch(s){case"domfile":a.data=n.files[0].getAsDataURL();break;case"filter":n.select();try{a.data=r.selection.createRange().text}catch(c){e.log(i+"Get image data error, the error is: "),e.log(c,"dir")}finally{r.selection.empty()}a.data||(a.data=n.value);break;case"html5":var h=new FileReader;h.onload=function(e){a.data=e.target.result,l()},h.onerror=function(t){e.log(i+"File Reader Error. Your browser may not fully support html5 file api","warning"),a.fire(o.error)},n.files&&h.readAsDataURL(n.files[0]);break;case"simple":default:a.data=n.value}a.data?l():s!="html5"&&(e.log(i+"Retrive Data error."),f(u),a.fire(o.error))}else e.log(i+"File Input Element does not exists.");return a.data}}),l},{requires:["dom","event"]}),KISSY.add("gallery/form/1.2/uploader/plugins/progressBar/progressBar",function(e,t,n){function c(t,n){var r=this;n=e.merge({wrapper:i(t)},n),c.superclass.constructor.call(r,n)}var r="",i=t.all,s="progressbar",o="role",u="aria-valuemin",a="aria-valuemax",f="aria-valuenow",l="data-value";return e.mix(c,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}}),e.extend(c,n,{render:function(){var e=this,t=e.get("wrapper"),n=e.get("width");if(!t.length)return!1;t.addClass(c.cls.PROGRESS_BAR).width(n),e._addAttr(),!e.get("visible")&&e.hide(),e.set("bar",e._create()),e.fire(c.event.RENDER)},show:function(){var e=this,t=e.get("wrapper");t.fadeIn(e.get("duration"),function(){e.set("visible",!0),e.fire(c.event.SHOW,{visible:!0})})},hide:function(){var e=this,t=e.get("wrapper");t.fadeOut(e.get("duration"),function(){e.set("visible",!1),e.fire(c.event.HIDE,{visible:!1})})},_create:function(){var t=this,n=t.get("wrapper"),r=t.get("value"),s=t.get("tpl"),o=e.substitute(s,{value:r});return n.html(""),i(o).appendTo(n)},_addAttr:function(){var e=this,t=e.get("wrapper"),n=e.get("value");return t.attr(o,s),t.attr(u,0),t.attr(a,100),t.attr(f,n),e}},{ATTRS:{wrapper:{value:r},bar:{value:r},width:{value:100},value:{value:0,setter:function(e){var t=this,n=t.get("wrapper"),r=t.get("bar"),i=t.get("speed"),s;return e>100&&(e=100),e<0&&(e=0),s=n.width()*(e/100),r.animate({width:s+"px"},i,"none",function(){n.attr(f,e),r.attr(l,e),t.fire(c.event.CHANGE,{value:e,width:s})}),e}},visible:{value:!0},duration:{value:.3},tpl:{value:c.tpl.DEFAULT},speed:{value:.2}}}),c},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/queue",function(e,t,n){function o(e){var t=this;o.superclass.constructor.call(t,e)}var r="",i=t.all,s="[uploader-queue]:";return e.mix(o,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{ADD:"add",ADD_FILES:"addFiles",REMOVE:"remove",CLEAR:"clear",FILE_STATUS:"statusChange",UPDATE_FILE:"updateFile",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"}),e.extend(o,n,{add:function(t,n){var r=this,i={};return t.length>0?(i=[],e.each(t,function(e){i.push(r._addFile(e))})):i=r._addFile(t),n&&n.call(r),i},_addFile:function(t,n){if(!e.isObject(t))return e.log(s+"_addFile()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1;var r=this,i=r._setAddFileData(t),u=r.getFileIndex(i.id),a=r.get("fnAdd");return e.isFunction(a)&&(i=a(u,i)),r.fire(o.event.ADD,{index:u,file:i,uploader:r.get("uploader")}),n&&n.call(r,u,i),i},remove:function(t,n){var r=this,i=r.get("files"),u;return e.isString(t)&&(t=r.getFileIndex(t)),u=i[t],e.isObject(u)?(i=e.filter(i,function(e,n){return n!==t}),r.set("files",i),r.fire(o.event.REMOVE,{index:t,file:u}),n&&n.call(r,t,u),u):(e.log(s+"remove()\u4e0d\u5b58\u5728index\u4e3a"+t+"\u7684\u6587\u4ef6\u6570\u636e"),!1)},clear:function(){function n(){t=e.get("files");if(!t.length)return e.fire(o.event.CLEAR),!1;e.remove(0,function(){n()})}var e=this,t;n()},fileStatus:function(t,n,r){if(!e.isNumber(t))return!1;var i=this,s=i.getFile(t),u=i.get("theme"),a,f;return s?(a=s.status,n?a==n?i:(i.updateFile(t,{status:n}),f="_"+n+"Handler",u&&e.isFunction(u[f])&&(r=e.merge({uploader:i.get("uploader"),index:t,file:s,id:s.id},r),u[f].call(u,r)),i.fire(o.event.FILE_STATUS,{index:t,status:n,args:r,file:s}),i):a):!1},getFile:function(t){if(!e.isNumber(t))return!1;var n=this,r=n.get("files"),i=r[t];return e.isPlainObject(i)||(e.log("getFile():\u6587\u4ef6\u6570\u636e\u4e3a\u7a7a\uff01"),i={}),i},getFileIndex:function(t){var n=this,r=n.get("files"),i=-1;return e.each(r,function(e,n){if(e.id==t)return i=n,!0}),i},updateFile:function(t,n){if(!e.isNumber(t))return!1;if(!e.isObject(n))return e.log(s+"updateFile()\u7684data\u53c2\u6570\u6709\u8bef\uff01"),!1;var r=this,i=r.get("files"),u=r.getFile(t);return u?(e.mix(u,n),i[t]=u,r.set("files",i),r.fire(o.event.UPDATE_FILE,{index:t,file:u}),u):!1},getIndexs:function(t){var n=this,r=n.get("files"),i,s=[];return r.length?(e.each(r,function(n,r){e.isObject(n)&&(i=n.status,i==t&&s.push(r))}),s):s},getFiles:function(t){var n=this,r=n.get("files"),i=[];return r.length?(e.each(r,function(e){e&&e.status==t&&i.push(e)}),i):[]},_setAddFileData:function(t){var n=this,i=n.get("files");return e.isObject(t)?(t.id||(t.id=e.guid(o.FILE_ID_PREFIX)),t.size&&(t.textSize=e.convertByteSize(t.size)),t.status=r,i.push(t),t):(e.log(s+"_updateFileData()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1)}},{ATTRS:{fnAdd:{value:r},files:{value:[]},uploader:{value:r},theme:{value:r}}}),o},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/theme",function(e,t,n){function o(e){var t=this;o.superclass.constructor.call(t,e)}var r="",i=t.all,s={BUTTON:"-button",QUEUE:"-queue"};return e.extend(o,n,{render:function(){var e=this;e._LoaderCss(function(){e._addThemeCssName(),e.fire("render")})},afterUploaderRender:function(e){},_getStatusWrapper:function(e){return e&&e.children(".J_FileStatus")||i("")},displayFile:function(e,t,n){var r=this,i=r.get("duration");if(!t||!t.length)return!1;t[e&&"fadeIn"||"fadeOut"](i,function(){n&&n.call(r)})},_waitingHandler:function(e){},_startHandler:function(e){},_progressHandler:function(e){},_successHandler:function(e){},_errorHandler:function(e){},_restoreHandler:function(e){},_UploaderRender:function(e){var t=this;t._initQueue(),t._loadPlugins(e)},_addThemeCssName:function(){var e=this,t=e.get("name"),n=i(e.get("queueTarget")),o=i(e.get("buttonTarget"));if(t==r)return!1;n.length&&n.addClass(t+s.QUEUE),o.addClass(t+s.BUTTON)},_initQueue:function(){var e=this,t=e.get("queue");return t.set("fnAdd",function(t,n){return e._addCallback(t,n)}),t.set("theme",e),t.on("add",e._addFileHandler,e),t.on("remove",e._removeFileHandler,e),t.on("statusChange",function(t){e._setStatusVisibility(t)}),t},_LoaderCss:function(t){var n=this,i=n.get("cssUrl");if(i==r)return t.call(n),!1;e.use(i,function(){e.log(i+"\u52a0\u8f7d\u6210\u529f\uff01"),t.call(n)})},_addCallback:function(e,t){var n=this,r=n.get("queue"),i=n._appendFileDom(t);return r.updateFile(e,{target:i,statusWrapper:n._getStatusWrapper(i)}),r.fileStatus(e,"waiting"),n.displayFile(!0,i),n._bindTriggerEvent(e,t),r.getFile(e)},_removeFileHandler:function(e){var t=this,n=e.file;t.displayFile(!1,n.target)},_bindTriggerEvent:function(t,n){var r=this,s=r.get("queue"),o=r.get("uploader"),u=n.id,a=i(".J_Upload_"+u),f=i(".J_Cancel_"+
u),l=i(".J_Del_"+u);a.on("click",function(n){n.preventDefault();if(!e.isObject(o))return!1;o.upload(t)}),f.on("click",function(e){e.preventDefault(),o.cancel(t)}),l.on("click",function(e){e.preventDefault(),s.remove(u)})},_setStatusVisibility:function(t){var n=t.file.statusWrapper,r,i=t.file,s=i.status;if(!n||!n.length)return e.log("\u72b6\u6001\u5bb9\u5668\u5c42\u4e0d\u5b58\u5728\uff01"),!1;r=n.children(".status"),r.hide(),n.children("."+s+"-status").show()},_appendFileDom:function(t){var n=this,r=n.get("fileTpl"),s=i(n.get("queueTarget")),o;return s.length?(o=e.substitute(r,t),i(o).hide().appendTo(s).data("data-file",t)):!1},_loadPlugins:function(t){var n=this,r=n.get("plugins"),i=n.get("oPlugin"),s="gallery/form/1.2/uploader/plugins/",o=[];if(!r.length)return t&&t.call(n,i),!1;e.each(r,function(e){o.push(s+e+"/"+e)}),e.use(o.join(","),function(){e.each(arguments,function(e,t){t>=1&&(i[r[t-1]]=e)}),n.set("oPlugin",i),t&&t.call(n,i)})}},{ATTRS:{name:{value:r},cssUrl:{value:r},fileTpl:{value:r},plugins:{value:[]},oPlugin:{value:{}},queueTarget:{value:r},duration:{value:.3},queue:{value:r},uploader:{value:r},button:{value:r},auth:{value:r}}}),o},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/type/ajax",function(e,t,n){function o(e){var t=this;o.superclass.constructor.call(t,e)}var r="",i=t.all,s="[uploader-AjaxType]:";return e.mix(o,{event:e.merge(n.event,{PROGRESS:"progress"})}),e.extend(o,n,{upload:function(t){if(!t)return e.log(s+"upload()\uff0cfileData\u53c2\u6570\u6709\u8bef\uff01"),!1;var n=this;return n._setFormData(),n._addFileData(t),n.send(),n},stop:function(){var t=this,n=t.get("xhr");return e.isObject(n)?(n.abort(),t.fire(o.event.STOP),t):(e.log(s+"stop()\uff0cio\u503c\u9519\u8bef\uff01"),!1)},send:function(){var t=this,n=t.get("action"),r=t.get("formData"),i=new XMLHttpRequest;return i.upload.addEventListener("progress",function(e){t.fire(o.event.PROGRESS,{loaded:e.loaded,total:e.total})}),i.onload=function(n){var r={};try{r=e.JSON.parse(i.responseText)}catch(u){e.log(s+"ajax\u8fd4\u56de\u7ed3\u679c\u96c6responseText\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01")}t.fire(o.event.SUCCESS,{result:r})},i.open("POST",n,!0),r.append("type","ajax"),i.send(r),t._setFormData(),t.set("xhr",i),t},_setFormData:function(){var t=this;try{t.set("formData",new FormData),t._processData()}catch(n){e.log(s+"something error when reset FormData."),e.log(n,"dir")}},_processData:function(){var t=this,n=t.get("data"),r=t.get("formData");e.each(n,function(e,t){r.append(t,e)}),t.set("formData",r)},_addFileData:function(t){if(!e.isObject(t))return e.log(s+"_addFileData()\uff0cfile\u53c2\u6570\u6709\u8bef\uff01"),!1;var n=this,r=n.get("formData"),i=n.get("fileDataName");r.append(i,t),n.set("formData",r)}},{ATTRS:{formData:{value:r},ajaxConfig:{value:{type:"post",processData:!1,cache:!1,dataType:"json",contentType:!1}},xhr:{value:r},fileDataName:{value:r},form:{value:{}},fileInput:{value:r}}}),o},{requires:["node","./base"]}),KISSY.add("gallery/form/1.2/uploader/type/base",function(e,t,n){function s(e){var t=this;s.superclass.constructor.call(t,e)}var r="",i=t.all;return e.mix(s,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}}),e.extend(s,n,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:r},data:{value:{}}}}),s},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/type/flash",function(e,t,n,r){function u(e){var t=this;u.superclass.constructor.call(t,e),t.isHasCrossdomain(),t._init()}var i="",s=t.all,o="[uploader-FlashType]:";return e.mix(u,{event:e.merge(n.event,{SWF_READY:"swfReady",PROGRESS:"progress"})}),e.extend(u,n,{_init:function(){var t=this,n=t.get("swfUploader");if(!n)return e.log(o+"swfUploader\u5bf9\u8c61\u4e3a\u7a7a\uff01"),!1;n.on("contentReady",function(e){t.fire(u.event.SWF_READY)},t),n.on("uploadStart",t._uploadStartHandler,t),n.on("uploadProgress",t._uploadProgressHandler,t),n.on("uploadCompleteData",t._uploadCompleteDataHandler,t),n.on("uploadError",t._uploadErrorHandler,t)},upload:function(t){var n=this,r=n.get("swfUploader"),i=n.get("action"),s="POST",o=n.get("data"),u=n.get("fileDataName");return u||(u="Filedata"),n.set("uploadingId",t),e.mix(o,{type:"flash"}),r.upload(t,i,s,o,u),n},stop:function(){var e=this,t=e.get("swfUploader"),n=e.get("uploadingId");return n!=i&&(t.cancel(n),e.fire(u.event.STOP,{id:n})),e},_uploadStartHandler:function(e){var t=this;t.fire(u.event.START,{file:e.file})},_uploadProgressHandler:function(t){var n=this;e.mix(t,{loaded:t.bytesLoaded,total:t.bytesTotal}),e.log(o+"\u5df2\u7ecf\u4e0a\u4f20\u5b57\u8282\u6570\u4e3a\uff1a"+t.bytesLoaded),n.fire(u.event.PROGRESS,{loaded:t.loaded,total:t.total})},_uploadCompleteDataHandler:function(t){var n=this,r;try{r=JSON.parse(t.data)}catch(s){e.log(o+"json\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01"),n.fire(u.event.ERROR,{msg:"\u4e0d\u662f\u5408\u6cd5\u7684json\u6570\u636e"})}e.log(o+"\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+r),n.set("uploadingId",i),n.fire(u.event.SUCCESS,{result:r})},_uploadErrorHandler:function(e){var t=this;t.set("uploadingId",i),t.fire(u.event.ERROR,{msg:e.msg})},isHasCrossdomain:function(){var t=location.hostname;e.io({url:"http://"+t+"/crossdomain.xml",dataType:"xml",error:function(){e.log("\u7f3a\u5c11crossdomain.xml\u6587\u4ef6\u6216\u8be5\u6587\u4ef6\u4e0d\u5408\u6cd5\uff01")}})}},{ATTRS:{action:{value:i,getter:function(t){var n=/^http/;if(!n.test(t)){var r=location.href,i=r.split("/"),s;s=e.filter(i,function(e,t){return t<i.length-1}),t=s.join("/")+"/"+t}return t}},swfUploader:{value:i},uploadingId:{value:i}}}),u},{requires:["node","./base"]}),KISSY.add("gallery/form/1.2/uploader/type/iframe",function(e,t,n){function u(e){var t=this;u.superclass.constructor.call(t,e)}var r="",i=t.all,s="[uploader-iframeType]:",o="ks-uploader-iframe-";return e.mix(u,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}" style="visibility: hidden;">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:e.mix(n.event,{CREATE:"create",REMOVE:"remove"})}),e.extend(u,n,{upload:function(t){var n=this,r=i(t),o;if(!r.length)return!1;n.fire(u.event.START,{input:r}),n.set("fileInput",r),n._create(),o=n.get("form");if(!o)return e.log(s+"form\u8282\u70b9\u4e0d\u5b58\u5728\uff01"),!1;o.getDOMNode().submit()},stop:function(){var e=this,t=e.get("iframe");return t.attr("src",'javascript:"<html></html>";'),e._remove(),e.fire(u.event.STOP),e.fire(u.event.ERROR,{status:"abort",msg:"\u4e0a\u4f20\u5931\u8d25\uff0c\u539f\u56e0\uff1aabort"}),e},dataToHidden:function(t){if(!e.isObject(t)||e.isEmptyObject(t))return"";var n=this,i=r,s=n.get("tpl"),o=s.HIDDEN_INPUT;if(!e.isString(o))return"";for(var u in t)i+=e.substitute(o,{name:u,value:t[u]});return i},_createIframe:function(){var t=this,n=o+e.guid(),r=t.get("tpl"),u=r.IFRAME,a=t.get("iframe"),f,l;return e.isEmptyObject(a)?e.isString(u)?e.isString(n)?(f=e.substitute(r.IFRAME,{id:n}),l=i(f),l.on("load",t._iframeLoadHandler,t),i("body").append(l),t.set("id",n),t.set("iframe",l),l):(e.log(s+"id\u5fc5\u987b\u5b58\u5728\u4e14\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\uff01"),!1):(e.log(s+"iframe\u7684\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1):a},_iframeLoadHandler:function(t){var n=this,i=t.target,o=u.event.ERROR,a=i.contentDocument||window.frames[i.id].document,f;if(!a||!a.body)return n.fire(o,{msg:"\u670d\u52a1\u5668\u7aef\u8fd4\u56de\u6570\u636e\u6709\u95ee\u9898\uff01"}),!1;f=a.body.innerHTML,e.log(s+"\u670d\u52a1\u5668\u7aef\u8f93\u51fa:"+f);if(f==r)return!1;try{f=JSON.parse(f)}catch(l){e.log(s+"json\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01"),n.fire(o,{msg:"\u6570\u636e\uff1a"+f+"\u4e0d\u662f\u5408\u6cd5\u7684json\u6570\u636e"})}n.fire(u.event.SUCCESS,{result:f}),n._remove()},_createForm:function(){var t=this,n=t.get("id"),r=t.get("tpl"),o=r.FORM,u=t.get("data"),a=t.get("action"),f=t.get("fileInput"),l,c,h;return e.isString(o)?e.isString(a)?(l=t.dataToHidden(u),l+=t.dataToHidden({type:"iframe"}),h=e.substitute(o,{action:a,target:n,hiddenInputs:l}),c=i(h).append(f),i("body").append(c),t.set("form",c),c):(e.log(s+"action\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1):(e.log(s+"form\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1)},_create:function(){var e=this,t=e._createIframe(),n=e._createForm();e.fire(u.event.CREATE,{iframe:t,form:n})},_remove:function(){var t=this,n=t.get("form");if(!n)return e.log(s+"form\u8282\u70b9\u4e0d\u5b58\u5728\uff01"),!1;n.remove(),t.reset("form"),t.fire(u.event.REMOVE,{form:n})}},{ATTRS:{tpl:{value:u.tpl},id:{value:o+e.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:r}}}),u},{requires:["node","./base"]}),KISSY.add("gallery/form/1.2/uploader/urlsInput",function(e,t,n){function o(e,t){var n=this;o.superclass.constructor.call(n,t),n.set("wrapper",i(e))}var r="",i=t.all,s="[uploader-urlsInput]:";return e.mix(o,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'}),e.extend(o,n,{render:function(){var t=this,n=t.get("wrapper"),r=t.get("name"),o=document.getElementsByName(r)[0];return e.isObject(n)?(o?(e.log(s+"urls input found"),t.set("input",i(o))):t._create(),t):(e.log(s+"container\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1)},add:function(t){if(!e.isString(t))return e.log(s+"add()\u7684url\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1;var n=this,i=n.get("urls"),o=n.isExist(t);return i[0]==r&&(i=[]),o?(e.log(s+"add()\uff0c\u6587\u4ef6\u8def\u5f84\u5df2\u7ecf\u5b58\u5728\uff01"),n):(i.push(t),n.set("urls",i),n._val(),n)},remove:function(t){if(!t)return!1;var n=this,r=n.get("urls"),i=n.isExist(t),o=new RegExp(t);return i?(r=e.filter(r,function(e){return!o.test(e)}),n.set("urls",r),n._val(),r):(e.log(s+"remove()\uff0c\u4e0d\u5b58\u5728\u8be5\u6587\u4ef6\u8def\u5f84\uff01"),!1)},parse:function(){var t=this,n=t.get("input");if(n){var r=i(n).val(),o=t.get("split"),u;return u=r.split(o),t.set("urls",u),u}return e.log(s+"cannot find urls input."),[]},_val:function(){var e=this,t=e.get("urls"),n=e.get("input"),r=e.get("split"),i=t.join(r);return n.val(i),i},isExist:function(t){var n=this,r=!1,i=n.get("urls"),s=new RegExp(t);return i.length?(e.each(i,function(e){if(s.test(e))return r=!0}),r):!1},_create:function(){var t=this,n=t.get("wrapper"),r=t.get("tpl"),o=t.get("name"),u=t.get("urls"),a;return!n||n.length<=0?(e.log(s+"UrlsInput container not specified!","warn"),!1):!e.isString(r)||!e.isString("name")?(e.log(s+"_create()\uff0ctpl\u548cname\u5c5e\u6027\u4e0d\u5408\u6cd5\uff01"),!1):(a=i(e.substitute(r,{name:o,value:u})),n.append(a),t.set("input",a),e.log(s+"input created."),a)}},{ATTRS:{name:{value:r},urls:{value:[]},tpl:{value:o.TPL},split:{value:",",setter:function(e){var t=this;return t._val(),e}},input:{value:r},wrapper:{value:r}}}),o},{requires:["node","base"]});
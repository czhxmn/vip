KISSY.add("page/mods/spu-ratting",["node","base","cm/rate-platform/common/"],function(t,e){"use strict";function n(t,e){var r=this;if(n.superclass.constructor.call(r,e),r.el=a(t),!t)throw new Error("SPURatting Error: el is not found");r.init()}var a=e("node").all,r=e("base"),i=e("cm/rate-platform/common/"),o="spu-ratting-star-on",l=".spu-ratting-control",s=".spu-ratting-star";return KISSY.extend(n,r,{init:function(){var t=this,e=this.el;i.tooltip.init({node:e,selector:s,opts:function(t){return{content:a(t).attr("data-desc"),placement:"t"}}}),e.delegate("mouseenter",s,t.spuRattingStarMouseEnter,t).delegate("click",s,t.spuRattingStarClick,t).delegate("mouseleave",l,t.spuRattingMouseLeave,t),a(l,e).each(function(e){t.updateUI(e)}),t.initAria()},initAria:function(){var t=this.el;a(l,t).attr("tabindex","0").attr("role","radiogroup").each(function(t){t.attr("aria-label",t.siblings(".spu-ratting-title").text())}),a(s,t).attr("role","radio").each(function(t){t.attr("aria-label",t.attr("data-desc"))}),t.delegate("keydown",l,this.spuRattingKeyDown,this),this.on("change",function(t){var e=a(t.elcontrol).children(),n=e.item(t.current),r=e.item(t.prev);t.current!==-1&&a(t.elcontrol).attr("tabindex",-1),r&&r.attr("aria-checked","false").attr("tabindex",""),n&&n.attr("aria-checked","true").attr("tabindex",0).getDOMNode().focus()})},spuRattingStarMouseEnter:function(t){var e=a(t.target),n=e.parent();this.updateUI(n,this.getIndexByEl(n,e.getDOMNode()))},spuRattingMouseLeave:function(t){this.updateUI(a(t.currentTarget))},spuRattingStarClick:function(t){var e=a(t.currentTarget),n=e.parent();this.setIndex(n,this.getIndexByEl(n,e.getDOMNode())),i.tooltip.hide(t.currentTarget)},getIndexByEl:function(t,e){return KISSY.indexOf(e,t.children())},getInput:function(t){var e=a(t).attr("data-input");return e?a("#"+e):null},getDesc:function(t,e){"undefined"==typeof e&&(e=this.getIndex(t));var n=a(t).children(s).item(e);return n?n.attr("data-desc"):""},setIndex:function(t,e){var n=this,r=a(t),i=n.getInput(r),o=r.children(s).length-1;if(!i)return void KISSY.log("no input could not save!");e=e<-1?-1:e>o?o:e;var l=n.getIndex(t),u=n.getDesc(t,e);l!==e&&n.fire("change",{prev:l,current:e,elcontrol:t,desc:u}),n.updateUI(t,e),i.val(e+1)},getIndex:function(t){var e=this.getInput(t);if(!e)return-1;var n=parseInt(e.val(),10);return isNaN(n)?-1:n-1},updateUI:function(t,e){var n=a(t),r=n.children(s);if("undefined"==typeof e&&(e=this.getIndex(t)),r.length<e)throw new Error("index larger than length");if(!n)throw new Error("No Control");r.each(function(t,n){var a=t.hasClass(o);!a&&n<=e&&t.addClass(o),a&&n>e&&t.removeClass(o)})},spuRattingKeyDown:function(t){var e=this;if(!(t.keyCode>40||t.keyCode<37)){t.preventDefault();var n=a(t.target);n.hasClass(s)&&(n=n.parent());var r=e.getIndex(n);switch(t.keyCode){case 37:case 38:r-=1;break;case 39:case 40:r+=1;break;default:return}e.setIndex(n,r)}}}),n}),KISSY.add("utils/placeholder/index",["node"],function(t,e){function n(t,e){var n=this,r=a.one(e.elLabel),i=r.parent(),o=a.one(t);r&&o&&(n.elLabel=r,n.elInput=o,n.elField=i,n.show(),r.on("click",function(){o.getDOMNode().focus()}),o.on("blur",function(){n.blur(),""===o.val()&&n.show()}).on("focus",function(){n.focus()}).on("keydown",function(t){t&&9!==t.keyCode&&setTimeout(function(){n.hide()},0)}),""===o.val()&&n.show(),setInterval(function(){""!==o.val()&&n.hide()},1111))}var a=e("node"),r="ph-hide",i="ph-focus";return KISSY.augment(n,{show:function(){this.elField.removeClass(r),this.elLabel.show()},hide:function(){this.elField.addClass(r),this.elLabel.hide()},focus:function(){this.elField.addClass(i)},blur:function(){this.elField.removeClass(i)}}),n}),KISSY.add("utils/wordcounter/index",["node","ua","event"],function(t,e){function n(t){var e=this;e.lock=!1,e.elti=a(t),e.count=e.elti.val().length,e.maxlength=parseInt(e.elti.attr("maxlength"),10),r.chrome&&e.elti.attr("maxlength",""),e.elti.on("keyup",e.update,e)}var a=e("node").all,r=e("ua"),i=e("event");return KISSY.augment(n,i.Target,{update:function(){var t=this;t._updateCount();var e=t.maxlength-t.count;t.fire("countupdate",{count:t.count,remain:e})},_updateCount:function(){var t=this.elti,e=t.val(),n=e.length,a=this.maxlength;e.length>a&&(t.val(e.substr(0,a)),n=a),this.count=n}}),n}),KISSY.add("utils/_3rd/log",function(){function t(){for(var t=n.shift();t;)t(e),t=n.shift()}var e,n=[];return{use:function(a){return n.push(a),e&&"loading"!==e?void t():(e="loading",void KISSY.use("tbc/log/",function(n,a){e=a.getLogger("cm/rate-platform"),t()}))}}}),KISSY.add("utils/env/index",["node","json","utils/_3rd/log"],function(t,e){"use strict";function n(){if(!a){a={};var t=location.search.substring(1);KISSY.each(t?t.split("&"):[],function(t){var e=t.split("=");a[e[0]]=decodeURIComponent(e[1]||"")})}return a}var a,r,i=e("node").all,o=e("json"),l=e("utils/_3rd/log");return{product:!/daily\./.test(location.hostname),getLocationParams:n,getLocationParam:function(t){return n()[t]||""},getInitParams:function(t){if(!r){r=t||{};try{var e=i("#J_InitParams");KISSY.mix(r,o.parse(e.text()))}catch(n){e.remove(),l.use(function(t){t.error("invalid json in #J_InitParams")})}}return r},isParamInUrl:function(t){return t in n()}}}),KISSY.add("utils/_3rd/uploader",["json"],function(t,e){function n(){for(var t=i.shift();t;)t(a),t=i.shift()}var a,r=e("json"),i=[];return{use:function(t){return i.push(t),a&&"loading"!==a?void n():(a="loading",void KISSY.use("gallery/form/1.2/uploader/",function(t,e){KISSY.use("gallery/form/1.2/uploader/auth/base, gallery/form/1.2/uploader/button/swfButton, gallery/form/1.2/uploader/type/flash, gallery/form/1.2/uploader/type/iframe",function(t,i,o,l,s){e.prototype._auth=function(){var t=this.get("buttonTarget"),e=this.get("uploader"),n=KISSY.form.parseConfig(t,"data-auth");if(KISSY.mix(n,this.get("authConfig")),this.set("authConfig",n),KISSY.isEmptyObject(n))return!1;var a=new i(e,{rules:n});return e.set("auth",a),a},o.ATTRS.flash.value.src=location.protocol+"//assets.alicdn.com/s/kissy/gallery/form/1.2/uploader/plugins/ajbridge/uploader.swf",l.ATTRS.action.getter=function(t){return/^https?:/.test(t)?t:/^\/\//.test(t)?location.protocol+t:/^\//.test(t)?location.protocol+"//"+location.host+t:location.protocol+"//"+location.host+location.pathname.substring(0,location.pathname.lastIndexOf("/")+1)+t},l.prototype.isHasCrossdomain=function(){},l.prototype._uploadCompleteDataHandler=function(t){var e,n=this;try{e=r.parse(t.data)}catch(a){KISSY.log("[uploader-FlashType]:json\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01"),n.fire(l.event.ERROR,{msg:"\u4e0d\u662f\u5408\u6cd5\u7684json\u6570\u636e"})}KISSY.log("[uploader-FlashType]:\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+e),n.set("uploadingId",""),n.fire(l.event.SUCCESS,{result:e})},s.prototype._iframeLoadHandler=function(t){var e,n=this,a=t.target,i=s.event.ERROR,o=a.contentDocument||window.frames[a.id].document;if(!o||!o.body)return n.fire(i,{msg:"\u670d\u52a1\u5668\u7aef\u8fd4\u56de\u6570\u636e\u6709\u95ee\u9898\uff01"}),!1;if(e=o.body.innerHTML,KISSY.log("[uploader-iframeType]:\u670d\u52a1\u5668\u7aef\u8f93\u51fa:"+e),""===e)return!1;try{e=r.parse(e)}catch(l){KISSY.log("[uploader-iframeType]:json\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01"),n.fire(i,{msg:"\u6570\u636e\uff1a"+e+"\u4e0d\u662f\u5408\u6cd5\u7684json\u6570\u636e"})}n.fire(s.event.SUCCESS,{result:e}),n._remove()},a=e,n()})}))}}}),KISSY.add("utils/_3rd/qrcode",function(){function t(){for(var t=n.shift();t;)t(e),t=n.shift()}var e,n=[];return{use:function(a){return n.push(a),e&&"loading"!==e?void t():(e="loading",void KISSY.getScript("//g.alicdn.com/crm/pc-support/0.0.8/js/serviceqrcode-min.js",function(){KISSY.use("pc-support/0.0.8/",function(n,a){e=a,t()})},"utf-8"))}}}),KISSY.add("utils/remark-uploader/theme/upload-tpl",function(){return{html:'<li id="queue-file-{id}" data-name="{name}">\n  <div class="queue-thumbnail"></div>\n  <div class="status-wrapper J_FileStatus">\n    <div class="status waiting-status">\u7b49\u5f85<br />\u4e0a\u4f20<span class="J_Img_Del_{id} delete-btn">\u5220\u9664</span></div>\n    <div class="status start-status progress-status">\n      <div class="J_ProgressBar_{id} uploader-progress"></div>\n      <a class="J_Img_Del_{id} delete-btn" href="#uploadCancel">\u5220\u9664</a>\n    </div>\n    <div class="status success-status"><span class="J_Img_Del_{id} delete-btn">\u5220\u9664</span></div>\n    <div class="status cancel-status"></div>\n    <div class="status error-status upload-error"><span class="error-msg J_ErrorMsg">\u4e0a\u4f20<br>\u5931\u8d25</span><a href="#" class="J_Img_Del_{id} delete-btn">\u5220\u9664</a></div>\n  </div>\n</li>\n'}}),KISSY.add("utils/remark-uploader/theme/index",["node","ua","./upload-tpl","gallery/form/1.2/uploader/index"],function(t,e){function n(t){n.superclass.constructor.call(this,t),this.get("buttonTarget").addClass("btn-"+r.shell)}var a=e("node").all,r=e("ua"),i=e("./upload-tpl"),o='<img src="{src}" />',l=KISSY.substitute(o,{src:"//img.alicdn.com/tps/i2/T1TSzXXotXXXbrlo..-14-14.gif"});return e("gallery/form/1.2/uploader/index"),KISSY.use("gallery/form/1.2/uploader/theme",function(t,e){KISSY.extend(n,e,{updateCounter:function(){var t=this,e=t.get("queue"),n=t.get("queueTarget"),a=t.get("maxLen"),r=e.get("files").length;n.siblings(".upload-msg").css("color","").text(r+"/"+a),t._setDisabled()},_setDisabled:function(){var t=this,e=t.get("queue"),n=t.get("maxLen"),a=e.get("files").length;a>=n?t.get("button").set("disabled",!0):t.get("button").set("disabled",!1)},afterUploaderRender:function(){var t=this,e=t.get("queue");e.on("add",function(){t.updateCounter()}),e.on("remove clear restore",function(){t.updateCounter()}),e.get("files").length>0&&t.updateCounter()},_addFileHandler:function(t){var e=t.file,n=a(".J_Img_Del_"+e.id);n.data("data-file",e),n.on("click",this._delHandler,this)},_delHandler:function(t){var e=this,n=e.get("uploader"),r=e.get("queue"),i=a(t.target).data("data-file"),o=i.id,l=r.getFileIndex(o),s=i.status;"start"!=s&&"progress"!=s||n.cancel(l),r.remove(o)},_getStatusWrapper:function(t){return t.children(".J_FileStatus")},_waitingHandler:function(){},_startHandler:function(t){var e=this,n=t.uploader,r=t.index,i=e.get("queue"),o=n.get("type"),s=a(".J_ProgressBar_"+t.id);if(t.file.target.one(".queue-thumbnail").html(l),"ajax"==o||"flash"==o){var u,c=e.get("oPlugin").progressBar;c&&(u=new c(s,{width:40}),u.render(),e.set("progressBar",u)),i.updateFile(r,{progressBar:u})}},_progressHandler:function(t){var e=t.file,n=t.loaded,a=t.total,r=Math.ceil(n/a*100),i=e.progressBar;return!!i&&void i.set("value",r)},_successHandler:function(t){var e=this;t.file.target.one(".queue-thumbnail").html(KISSY.substitute(o,{src:t.file.result.thumbnail})),KISSY.later(function(){e.updateCounter()},100)},_errorHandler:function(t){var e=this,n=decodeURIComponent(t.msg);"max"!==t.rule&&("invalid data"===n&&(n="\u56fe\u7247\u6570\u636e\u51fa\u9519\u4e86\uff0c \u8bf7\u68c0\u67e5\u56fe\u7247"),n||(n="\u51fa\u73b0\u672a\u77e5\u9519\u8bef"),alert(n),setTimeout(function(){e.get("queue").remove(t.index)},500))}},{ATTRS:{fileTpl:{value:i.html},plugins:{value:["progressBar"]},maxLen:{value:5}}})}),n}),KISSY.add("utils/remark/pic-uploader",["node","cookie","utils/env/","utils/_3rd/uploader","utils/_3rd/qrcode","utils/remark-uploader/theme/"],function(t,e){"use strict";function n(t,e,n){var r=KISSY.mix({hiddenInputNamePrefix:"pictures",tradeId:"",sellerId:"",tbToken:"",buyerId:"",on:null},n),i=a(".J_btn",e),s=a(".J_MobileUpload",e),u=a("ul.J_queue",e),c=new t(i,u,{multiple:!1,type:["ajax","iframe"],name:"picture",theme:"utils/remark-uploader/theme",restoreHook:r.restoreHook,urlsInputName:r.hiddenInputNamePrefix+r.tradeId,serverConfig:{action:l,dataType:"json",data:{sellerNumId:r.sellerId,bizOrderId:r.tradeId,_tb_token_:r.tbToken}}});c.on("init",function(){function t(t,n){var a=t.file.result,i=r.on&&r.on[n];a&&a.data&&a.data.url&&KISSY.isFunction(i)&&i.apply(c,[{id:a.data.url,thumbnail:a.thumbnail},e])}var n=this.get("uploader"),a=n.get("queue");n.on("success",function(e){t(e,"success")}),a.on("remove",function(e){t(e,"remove")}),s.length&&o.use(function(t){a.on("add remove",function(){var t=a.get("theme").get("maxLen")-a.get("files").length;t<1?s.addClass(".uploader-button-disabled"):s.hasClass("uploader-button-disabled")&&s.removeClass(".uploader-button-disabled")});var i=new t({btn:s,type:"jpg/gif/png/bmp",app:"taobaoapp",max:5,subType:"qr_"+KISSY.now()+"."+Math.round(1e4*Math.random())+KISSY.guid(),token:"rateToken20130606",userId:r.buyerId,title:"\u8bc4\u4ef7\u4f20\u56fe",bizMap:{tradeId:r.tradeId,sellerId:r.sellerId,buyerId:r.buyerId},xmppcallback:function(t){var e=t.data;e&&e.fileIds&&(n.restore(KISSY.map(e.fileIds,function(t,n){return t=""+t,{name:"mobile-upload.png",size:5,type:"image/png",result:{result:1,thumbnail:e.picUrls[n]+"_40x40.jpg",data:{name:"mobile-upload.png",url:t}}}})),i.hide())}});s.on("click",function(t){t.preventDefault();var n=a.get("theme").get("maxLen")-a.get("files").length;if(0!==n){i.param.max=n,i.show();var r=e.offset();i.offset(r.top-100,r.left)}})})})}var a=e("node").all,r=(e("cookie"),e("utils/env/")),i=e("utils/_3rd/uploader"),o=e("utils/_3rd/qrcode"),l=location.protocol+"//rate."+(r.product?"taobao.com":"daily.taobao.net")+"/upload_pic.htm?_input_charset=utf-8&at_iframe=1";return e("utils/remark-uploader/theme/"),{create:function(t,e){var r=a(t);r.length&&i.use(function(t){r.each(function(r){n(t,a(r),e)})})}}}),KISSY.add("utils/_3rd/sns",function(){function t(){for(var t=n.shift();t;)t(e),t=n.shift()}var e,n=[];return{use:function(a){return n.push(a),e&&"loading"!==e?void t():(e="loading",void KISSY.getScript("//g.alicdn.com/tb/snsdk/0.0.11/core.min.js",function(){e=window.SNS,t()}))}}}),KISSY.add("page/mods/rate-item",["node","ua","event","cm/rate-platform/common/","./spu-ratting","utils/placeholder/","utils/wordcounter/","utils/remark/pic-uploader","utils/env/","utils/_3rd/sns"],function(t,e){"use strict";function n(t,e,n){var r=this,i=a(t),l=i.attr("data-id");r.config=n,r.score=-1,r.el=i,r.id=l,r.el_privacy=a(".privacy-control",i),r.form=e,r.el_msg_box=i.one(".rate-msg-box"),r.el_msg_input=i.one(".rate-msg"),r.el_ctl_star=i.one(".rate-control-stars"),r.el_tips=i.one("div.gift-tip"),r.el_stars=i.one("span.rate-stars"),r.el_ratecontrol=i.one(".rate-control"),r.el_sharebox=i.one(".share-box"),r.el_textcounter=i.one(".text-counter"),r.initPlaceHolder(),o.placeholder.init("textarea[placeholder]"),r.initTextCounter(),o.textLimit.init(".J_TbRate_Remark_Service textarea",function(t){var e=a(t);return{statsNode:a(".text-stats",e.closest(".ta-wrapper")),statsComposer:function(t,e){return"<strong>"+(e-t)+"</strong>\u5b57"}}}),r.initSpuRatting(),r.initRateControl(),r.initPrivacy(),r.initShareSites(),c.create(a(".J_photo_uploader",i),{restoreHook:"#J_ImageUploaderRestore_"+l,tradeId:l,sellerId:f.sellerId,tbToken:f.tbToken,buyerId:f.buyerId}),c.create(a(".J_TbRate_PicUpload4Svc",i),{hiddenInputNamePrefix:"server_does_not_need_it_but_frontend_does",restoreHook:null,tradeId:l,sellerId:f.sellerId,tbToken:f.tbToken,buyerId:f.buyerId,on:{success:function(t,e){var n=e.data("tbRateIdPathMap");n||(n={},e.data("tbRateIdPathMap",n));var a=t.thumbnail;/(?:https?:)?\/\/[^\/]+(\/.*)_\d+x\d+\.\w+$/.test(a)&&(a=RegExp.$1),n[t.id]=a},remove:function(t,e){var n=e.data("tbRateIdPathMap");n&&delete n[t.id]}}}),r.initEvent(),h&&r.ie6HoverFix()}var a=e("node").all,r=e("ua"),i=e("event"),o=e("cm/rate-platform/common/"),l=e("./spu-ratting"),s=e("utils/placeholder/"),u=e("utils/wordcounter/"),c=e("utils/remark/pic-uploader"),d=e("utils/env/"),p=e("utils/_3rd/sns"),f=d.getInitParams(),h=r.ie&&r.ie<=7;return KISSY.augment(n,i.Target,{initRateControl:function(){var t=this;t.el_ratecontrol&&(t.rateradios=t.el_ratecontrol.all("input"),t.rateradios&&t.initRateScore())},initTextCounter:function(){var t=this,e=new u(t.el_msg_input);e.on("countupdate",function(e){var n=t.el_msg_box.one(".r-t-counter"),a=500-e.count;n.html(Math.max(a,0))}),t.el_msg_input.on("focus",function(){t.el_textcounter.show()}),t.el_msg_input.on("blur",function(){t.el_textcounter.hide()})},initPlaceHolder:function(){new s(this.el_msg_input,{elLabel:this.el.one(".ph-label")[0]})},initEvent:function(){var t=this;t.el.delegate("change",".rate-control",function(){t.fire("rate-change"),t.initRateScore()}).delegate("change",".privacy-control",function(e){var n=a(e.target);t.fire("privacy-update",{value:n.val()})}),t.on("privacy-update",function(){t.initPrivacy()})},initPrivacy:function(){var t=this,e="invisible",n="checked";a("input.privacy-control",t.el).each(function(a){var r=a.parent("label");a.prop("checked")?(r.addClass(n),"0"===a.val()?t.el.all(".share-selector").removeClass(e):t.el.all(".share-selector").addClass(e)):r.removeClass(n)})},ie6HoverFix:function(){this.el.delegate("mouseenter","label",function(t){a(t.target).addClass("hover")}).delegate("mouseleave","label",function(t){a(t.target).removeClass("hover")})},initSpuRatting:function(){var t=this,e=t.el_spu_ratting=t.el.all(".spu-ratting-item");e&&e.length&&(t.spuratting=new l(t.el,e))},initRateScore:function(){var t,e,n=this,r=n.config.placeholder,i=r.BAD,o=r.NORMAL,l=n.el.attr("data-prompt")||r.GOOD,s=n.getRateScore();switch(s){case-1:t=i;break;case 1:t=l;break;case 0:t=o;break;default:t=l}if("number"==typeof s&&s<=0?n.el.addClass("rate-level-normal"):n.el.removeClass("rate-level-normal"),a("input",n.el_ratecontrol).each(function(t){t.prop("checked")?t.parent("li").addClass("rate-checked"):t.parent("li").removeClass("rate-checked")}),n.el.one(".ph-label").html(t),1===s?e="\u4eb2\uff0c\u597d\u8bc4\u65e0\u6cd5\u4fee\u6539\u548c\u5220\u9664\uff0c\u8bf7\u9a8c\u8d27\u540e\u518d\u5bf9\u5546\u54c1\u548c\u8d2d\u7269\u611f\u53d7\u505a\u51fa\u8bc4\u8bba\u3002":0!==s&&s!==-1||(e="\u4eb2\uff0c\u5f88\u62b1\u6b49\u6ca1\u80fd\u7ed9\u60a8\u5e26\u6765\u826f\u597d\u7684\u8d2d\u7269\u4f53\u9a8c\uff0c\u5982\u6709\u4e0d\u6ee1\uff0c\u60a8\u53ef\u8054\u7cfb\u5356\u5bb6\u534f\u5546\u6216\u53d1\u8d77\u552e\u540e\u7ef4\u6743\u3002"),e){var u=this.el_ratecontrol.one("p");u||(u=a('<p style="color: #999;"></p>').appendTo(this.el_ratecontrol)),u.text(e)}else this.el_ratecontrol.all("p").remove()},checkForm:function(){var t=this,e=t.el_msg_input,n=KISSY.trim(e.val()),a=t.getRateScore(),r="";return t.hideError(),t.el_ratecontrol&&(n&&null===a&&(r="\u53d1\u8868\u8bc4\u8bba\u7684\u5b9d\u8d1d\u5fc5\u987b\u9009\u62e9\u597d\u3001\u4e2d\u3001\u5dee\u8bc4"),null!==a&&a<=0&&!n&&(r="\u4e2d\u5dee\u8bc4\u4e00\u5b9a\u8981\u8bf4\u660e\u539f\u56e0\u54e6")),r&&t.showError(r),r},initShareSites:function(){var t=this,e="share-sites-"+this.id,n=a(".sns-site-holder",this.el);n.length&&p.use(function(a){a.ui("sharesite",{output:n,batchCheckbox:!0,defaultChecked:!1,sitesHiddenName:e,checkedSites:"[]",callback:{initCallback:function(){t.fire("sharesite-init")}}})})},showError:function(t){var e=this.el_msg_box.one(".msg");e||(e=a('<div class="msg"></div>'),e.insertBefore(this.el_msg_box.one(".textinput"))),e.html('<p class="stop">'+t+"</p>").show()},hideError:function(){this.el_msg_box.all(".msg").hide()},getPrivate:function(){var t=a(".privacy-control",this.el),e="";return t.each(function(t){t.prop("checked")&&(e=t.val())}),e},privacyDisabled:function(){var t=a("input.privacy-control",this.el);return t&&t.length?t.prop("disabled"):null},getRateScore:function(){var t=this,e=t.rateradios,n="";return e&&e.each(function(t){t[0].checked&&(n=t.val())}),t.el_stars&&t.el_stars.all("input").each(function(t){t[0].checked&&(n=t.val())}),""==KISSY.trim(n)?null:parseInt(n,10)},setAnnoy:function(t){var e=this,n=t?"1":"",a=e.el_privacy;a&&!a.prop("disabled")&&a.val()!==n&&(a.children().each(function(t){t.val()===n&&t.prop("selected",!0)}),e.fire("annoychange",{checked:t}))},setGoodRate:function(t){this.el.one(".good-rate")[0].checked=t,this.initRateScore()}}),n}),KISSY.add("utils/retcode/index",["node"],function(t,e){var n,a=function(){},r=e("node").all,i=r("body").attr("data-spm"),o=r("body").attr("data-retcode-sample")||100,l=i&&window.__WPO?window.__WPO:{speed:a,error:a,retCode:a,custom:a,log:a,setConfig:a};return l.setConfig({sample:o,spmId:"a1z0b."+i,retCode:{}}),n=function(){function t(t){this.api=t,this.startTime=(new Date).getTime()}return t.prototype.finish=function(t,e){var n=(new Date).getTime(),a=n-this.startTime;l.retCode(this.api,t,a,e)},t.prototype.success=function(){var t=arguments.length<=0||void 0===arguments[0]?"\u63a5\u53e3\u8c03\u7528\u6210\u529f":arguments[0];this.finish(!0,t)},t.prototype.failed=function(){var t=arguments.length<=0||void 0===arguments[0]?"\u63a5\u53e3\u8c03\u7528\u5931\u8d25":arguments[0];this.finish(!1,t)},t}(),{retCode:function(t){return new n(t)},custom:function(t,e,n){l.custom(t,e,n)},error:function(t,e){l.error(t,e)}}}),KISSY.add("page/mods/personal-data",["io","utils/retcode/"],function(t,e){var n=e("io"),a=e("utils/retcode/"),r=a.retCode("\u83b7\u53d6\u7528\u6237\u4e2a\u4eba\u4fe1\u606f");return{data:{},queue:[],url:"",init:function(t){this.url=KISSY.substitute("{url}?userNumId={userID}&list={keys}",{url:t.url,userID:t.userID,keys:"{keys}"})},get:function(t,e){var n=this;return t in n.data?void e(n.data[t]):void n.addToLoader(t,e)},addToLoader:function(t,e){var n=this;n.queue.push({key:t,callback:e}),n.loaderCallback&&clearTimeout(n.loaderCallback),n.loaderCallback=setTimeout(function(){n.fire()},200)},fire:function(){var t=this,e=t.queue;t.queue=[],t.execQueue(e)},execQueue:function(t){var e=this;if(t.length){var a=[];KISSY.each(t,function(t){var e=t.key;KISSY.indexOf(e,a)===-1&&a.push(e)}),n({url:KISSY.substitute(e.url,{keys:a.join(",")}),dataType:"json",success:function(n){KISSY.each(a,function(t){e.data[t]=n[t]}),KISSY.each(t,function(t){var n=t.key,a=t.callback;n in e.data?a(e.data[n]):a.call(this)}),r.success()},error:function(){KISSY.each(t,function(t){t.callback.call(this)}),r.failed()}})}}}}),KISSY.add("page/controls/control",["node","../mods/personal-data"],function(t,e){function n(t){this.el=a(t)}var a=e("node").all,r=e("../mods/personal-data");return KISSY.augment(n,{updateValue:function(){this.setValue(this.getValue())},getValue:function(){return""},setValue:function(t){this.getInput().val(t)},check:function(){return null},getInput:function(){var t=this;return t.elInput||(t.elInput=a(KISSY.substitute('<input type="hidden" name="{name}" />',{name:t.getInputName()})),t.elInput.appendTo(t.el)),t.elInput},getInputName:function(){return this.el.attr("data-input-name")},getDefaultCtlValue:function(){return this.el.attr("data-value")},getDefaultValue:function(t){var e=this.getDefaultCtlValue();if(e)return void t(e);var n=this.el.attr("data-field");return n?void r.get(n,t):void t(null)},showError:function(t){var e=this;e.elError||(e.elError=a('<span class="ctl-error hide"></span>'),e.elError.appendTo(e.el)),e.elError.removeClass("hide").html(t)},hideError:function(){this.elError&&this.elError.addClass("hide")}}),n}),KISSY.add("utils/datepicker/index",["node","date/popup-picker","date/format","date/picker/assets/dpl.css"],function(t,e){"use strict";function n(t){var e=t.data(u)||{};return new s(e.format||"yyyy-MM-dd")}function a(){return i?i:(i=new l({showClear:!1,showToday:!1}),i.on("blur",function(){i.hide()}),i.on("select",function(t){this.hide();var e=o(i.get("align").node);t.value?e.val(n(e).format(t.value)):e.val(""),e.fire("change")}),i)}function r(t){var e=o(t.currentTarget);if(a(),e.val())try{i.set("value",n(e).parse(e.val()))}catch(r){}i.set("align",{node:e,points:["bl","tl"]}),i.show(),i.focus()}var i,o=e("node").all,l=e("date/popup-picker"),s=e("date/format"),u="ks-datepicker-data";return e("date/picker/assets/dpl.css"),{create:function(t,e){var n=KISSY.isFunction(e);o(t).each(function(){var t=this.data(u);t||(t={},this.on("focus",r)),n?KISSY.mix(t,e(this)):KISSY.mix(t,e),this.data(u,t)})}}}),KISSY.add("page/controls/date",["node","./control","utils/datepicker/"],function(t,e){function n(){n.superclass.constructor.apply(this,arguments),this.init()}var a=e("node").all,r=e("./control"),i=e("utils/datepicker/");return KISSY.extend(n,r,{getValue:function(){return this.elInput.val()},init:function(){this.elInput=a(".input",this.el),i.create(this.elInput,{format:"yyyyMMdd"})}}),n}),KISSY.add("page/controls/unit-text",["node","./control"],function(t,e){function n(){n.superclass.constructor.apply(this,arguments),this.init()}var a=e("node").all,r=e("./control");return KISSY.extend(n,r,{getValue:function(){return this.elInput.val()},setValue:function(t){this.elInput.val(t)},updateValue:function(){},getDefaultCtlValue:function(){return this.getValue()},init:function(){var t=this;t.el&&(t._inited||(t._inited=!0,t.elInput=a("input.input",t.el),t.dataType=t.el.attr("data-type"),t.getDefaultValue(function(e){"undefined"!=typeof e&&0!==e&&("number"===t.dataType&&0==e&&(e=""),t.setValue(e))}),"number"===t.dataType&&t.elInput.on("blur",t.checkInput,t)))},checkInput:function(){var t=this,e=t.getValue();if(t.el.removeClass("input-error"),t.elInput.attr("title",""),""!==e){var n=/^(\d)*(\.\d*)?$/;(!n.test(e)||Number(e)>1e3)&&(t.el.addClass("input-error"),t.elInput.attr("title","\u8f93\u5165\u6709\u8bef")),t.setValue(e)}}}),n}),KISSY.add("page/controls/radio",["node","./control"],function(t,e){function n(t){n.superclass.constructor.apply(this,arguments),this.el=a(t),this.init()}var a=e("node").all,r=e("./control");return KISSY.extend(n,r,{getValue:function(){var t=a(".ctl-radio-item-checked",this.el);return t.length&&t.attr("data-value"),""},init:function(){var t=this;t.el&&(t._inited||(t._inited=!0,t.el.delegate("click",".ctl-radio-item",function(e){var n=a(e.target);n.hasClass("ctl-radio-item")||(n=n.parent(".ctl-radio-item")),n&&t.select(n)}).delegate("keydown",".ctl-radio-group",function(e){var n,r=38===e.keyCode,i=40===e.keyCode;if(r||i){e.preventDefault();var o=a(".ctl-radio-item-checked",t.el);n=o.length?r?o.prev(".ctl-radio-item"):o.next(".ctl-radio-item"):a(".ctl-radio-item",t.el),n&&n.length&&t.select(n)}}),t.getDefaultValue(function(e){if("undefined"!=typeof e){var n=a(".ctl-radio-item",t.el);n.each(function(a){if(a.attr("data-value")==e)return t.select(n),!1})}})))},select:function(t){var e=a(t);this.setValue(e.attr("data-value")),e.addClass("ctl-radio-item-checked").attr("aria-checked","true"),e.siblings(".ctl-radio-item").removeClass("ctl-radio-item-checked").attr("aria-checked","false")},setRadio:function(t){var e=a(".ctl-radio-item",this.el);e.each(function(e){e.attr("data-value")==t?e.addClass("ctl-radio-item-checked"):e.removeClass("ctl-radio-item-checked")})},updateInput:function(){this.updateValue()}}),n}),KISSY.add("page/controls/lifemap-province",["node","event"],function(t,e){function n(t,e,n){var r=this,i=a(t).all("select"),o=KISSY.merge({val:"val"},n||{});i.length<1||!e||(KISSY.mix(r,{select:i,data:e,config:o}),KISSY.each(i,function(t,e){a(t).on("change",function(){var t=a(this.options[this.selectedIndex]),n=t.attr("data-val");r.fire("change",{select:this,text:t.text(),val:t.attr("value"),code:n}),i.length-e>1&&r.renderSelect(i[e+1],r.getCurrentData(n))})}))}var a=e("node").all,r=e("event");return KISSY.augment(n,r.Target,{init:function(){this.renderFirst()},renderFirst:function(){this.renderSelect(this.select[0],this.data)},getCurrentData:function(t){t=""+t;var e=t.match(/(\d{2})/g);return"00"==e[1]&&"00"==e[2]?this.data[t].child:"00"!=e[1]&&"00"==e[2]?this.data[[e[0],"0000"].join("")].child[[e[0],e[1],"00"].join("")].child:null},renderSelect:function(t,e,n){var r,i=this,o=[];t.options.length=0,KISSY.each(e,function(t){r||(r=t.code+"");var e=new Option(t.name,"text"==i.config.val?t.name:t.code);e.setAttribute("data-val",t.code),String(t.code).indexOf("99")>-1?(r=t.code,o.unshift(e)):o.push(e)}),KISSY.each(o,function(e){t.options[t.options.length]=e}),setTimeout(function(){n?a(t).val(n):t.options.selectedIndex=0;var e=KISSY.indexOf(t,i.select);e>0&&i.select[e+1]&&i.renderSelect(i.select[e+1],i.getCurrentData(n||r))},10)},focus:function(t,e){var n=this,a=n.data,r=e.match(/(\d{2})/g);0==t?(n.renderSelect(n.select[0],a,e),n.renderSelect(n.select[1],{}),n.renderSelect(n.select[2],{})):1==t?(n.renderSelect(n.select[0],a,[r[0],"0000"].join("")),n.renderSelect(n.select[1],a[[r[0],"0000"].join("")].child,e),n.renderSelect(n.select[2],{})):2==t&&(n.renderSelect(n.select[0],a,[r[0],"0000"].join("")),n.renderSelect(n.select[1],a[[r[0],"0000"].join("")].child,[r[0],r[1],"00"].join("")),n.renderSelect(n.select[2],n.data[[r[0],"0000"].join("")].child[[r[0],r[1],"00"].join("")].child,e))}}),n}),KISSY.add("page/controls/lifemap",["node","io","./control","./lifemap-province"],function(t,e){function n(){n.superclass.constructor.apply(this,arguments),this.init()}var a=e("node").all,r=e("io"),i=e("./control"),o=e("./lifemap-province");return KISSY.extend(n,i,{getValue:function(){var t=this,e="";if(a("#J_stores").val()){var n,r=[];t.elSelects.each(function(t){n=t[0].options[t[0].selectedIndex],n.value.indexOf("\u6240\u6709")<0&&r.push(n.text)}),4==r.length&&(e=r.join(" "))}return e},init:function(){this.elSelects=a("select",this.el),this._initLinkSelect()},check:function(){var t,e=this;return""==a("#J_stores").val()&&(t={el:a("#J_stores"),message:"\u8bf7\u9009\u62e9\u5546\u5bb6"}),t&&(e.el.css("background","#FF0").animate({background:"#FFF"},1,"",function(){e.el.css("background","")}),a(t.el).parent(".rev-ctl-sel-set").addClass(".rev-ctl-sel-set-error")),null},htmldecode:function(t){var e=document.createElement("div");return e.innerHTML=t,e.innerText||e.textContent},_initLinkSelect:function(){function t(t){r({url:n.el.attr("data-url-localstore"),type:"get",dataType:"jsonp",jsonp:"jsoncallback",data:{itemid:l,areaid:t}}).then(function(t){var e=t[0];e&&0==e.status?(u.options.length=0,KISSY.each(e.stores,function(t){u.options[u.options.length]=new Option(n.htmldecode(t.name),t.id)}),n.updateValue()):KISSY.log("\u83b7\u53d6\u5b9d\u8d1d\u573a\u6240\u4fe1\u606f\u51fa\u9519\uff1a"+e.msg)})}function e(){i.each(function(e){if(a(e).val().indexOf("\u6240\u6709"))return t(a(e).val()),!1}),t(a(i[2]).val())}var n=this,i=a("select","#J_ProvinceLink"),l=n.el.attr("data-orderid"),s=a("#J_County"),u=a("#J_stores")[0];a(i).on("change",function(){n.updateValue()}),s.on("change",function(){e()}),a(u).on("change",function(){n.updateValue()}),r({url:n.el.attr("data-url-area"),type:"get",dataType:"jsonp",jsonp:"jsoncallback",data:{itemid:l}}).then(function(t){var e=t[0];if(!e||"0"!==e.status)return void KISSY.log("\u83b7\u53d6\u5b9d\u8d1d\u573a\u6240\u4fe1\u606f\u51fa\u9519\uff1a"+e.msg);var n=new o("#J_ProvinceLink",e.allareas);e.level&&e.curarea&&(n.focus(e.level,e.curarea),KISSY.later(function(){2==s[0].options.length&&(s[0].selectedIndex=1,s.fire("change"))},500))})}}),n}),KISSY.add("page/mods/controls",["node","../controls/date","../controls/unit-text","../controls/radio","../controls/lifemap"],function(t,e){var n=e("node").all,a=e("../controls/date"),r=e("../controls/unit-text"),i=e("../controls/radio"),o=e("../controls/lifemap"),l=[];return{init:function(){n(".rev-ctl").each(function(){this.hasClass(".rev-ctl-date")?l.push(new a(this)):this.hasClass(".rev-ctl-text")?l.push(new r(this)):this.hasClass(".rev-ctl-radio")?l.push(new i(this)):this.hasClass(".rev-ctl-lifemap")&&l.push(new o(this))}),n(".item-rate-ctl").on("mouseover",function(t){var e=t.target;"INPUT"==e.tagName&&e.select&&e.select()})},check:function(){var t=[];return KISSY.each(l,function(e){var n=e.check();n&&t.push(n)}),t}}}),KISSY.add("utils/remark/simple-star",["node","event","cm/rate-platform/common/"],function(t,e){"use strict";function n(t,e){var n,r=this,o=a(t);r.el=o,r.config=KISSY.mix({tipstmpl:"<strong>{score} \u5206</strong> - {tooltip}</span>"},e),r.inputs=o.all("input"),r.images=[],r.checked=-1,n=a('<span class="ks-simplestar" />'),r.elCtl=n,n.insertAfter(o),i.tooltip.init({node:n,selector:"img",opts:function(t){var e=KISSY.indexOf(t,r.images);return{content:'<strong style="color: #F40;">'+(e+1)+"\u5206 "+r.getLevel(e)+"</strong><br />"+r.getTooltip(e),unsafe:!0}}}),n.delegate("mouseenter","img",function(t){
r.renderStar(KISSY.indexOf(t.currentTarget,r.images))}).delegate("mouseleave","img",function(){r.renderStar(-1)}).delegate("click","img",function(t){var e=KISSY.indexOf(t.currentTarget,r.images);r.inputs[e].checked=!0,r.monitorRadios(),i.tooltip.hide(t.currentTarget)}),e.el_tip?r.elTips=a(e.el_tip):(r.elTips=a('<span class="ks-ss-tips" />'),r.elTips.insertAfter(n)),o.css("position","absolute").css("left","-9999px"),r.inputs.each(function(){var t=new Image;t.src=l,r.images.push(t),n.append(t)}),KISSY.later(function(){r.initEvent()},10)}var a=e("node").all,r=e("event"),i=e("cm/rate-platform/common/"),o="//img.alicdn.com/tps/i3/T1eMt9XclyXXXXXXXX-19-19.png",l="//img.alicdn.com/tps/i2/T1j_SkXl0fXXXXXXXX-19-19.png",s="//img.alicdn.com/tps/i1/T1lgl9XfXyXXXXXXXX-19-19.png",u="ks-ss-focus",c="change",d=1;return KISSY.augment(n,r.Target,{initEvent:function(){var t=this,e=t.elCtl;t.on(c,function(e){t.renderStar(e.index),t.elTips.html(KISSY.substitute(t.config.tipstmpl,e))}),t.monitorRadios(),t.inputs.on("focus",function(){e.addClass(u)}).on("blur",function(){e.removeClass(u)}).on("change",function(){t.monitorRadios()}),KISSY.each(t.inputs,function(e,n){a(e).attr("title",t.getLevel(n)+"\uff0c"+t.getTooltip(n))})},monitorRadios:function(){var t=this,e=t.index();e!==t.checked&&(t.checked=e,t.fire(c,{score:e+1,levelText:t.getLevel(e),tooltip:t.getTooltip(e),index:e}))},index:function(){var t=-1;return this.inputs.each(function(e,n){e[0].checked&&(t=n)}),t},renderStar:function(t){var e=this,n=t!==-1?t:e.checked;KISSY.each(e.images,function(t,e){var a=l;n>=0&&n<=d&&e<=n&&(a=s),n>=0&&n>d&&e<=n&&(a=o),t.src=a})},getTooltip:function(t){return this.config.tooltips?this.config.tooltips[t]||t:t},getLevel:function(t){return this.config.levelText[t]||t}}),n}),KISSY.add("utils/_3rd/login",["io","promise","utils/retcode/"],function(t,e){function n(){return a({url:"/login_check_js.htm?type=json",dataType:"json",type:"post"}).then(function(t){return o.success(),t[0].token},function(){return o.failed(),""})}var a=e("io"),r=e("promise"),i=e("utils/retcode/"),o=i.retCode("\u68c0\u67e5\u767b\u5f55");return{check:function(){return n().then(function(t){if(t)return t;var e=new r.Defer;return KISSY.use("tbc/mini-login/2.1.0/",function(t,a){var r=new a;r.on("login",function(){n().then(function(t){e.resolve(t)})}),r.on("close",function(){e.reject("canceled")}),r.show()}),e.promise})}}}),KISSY.add("utils/_3rd/sdk",function(){function t(){for(var t=n.shift();t;)t(e),t=n.shift()}var e,n=[];return{use:function(a){return n.push(a),e&&"loading"!==e?void t():(e="loading",void KISSY.getScript("//g.alicdn.com/??tp/sdk/4.0.5/kissy/simpleSDKAIO.js",function(){KISSY.use("sdk/kissy/simpleSDK",function(n,a){e=a,t()})}))}}}),KISSY.add("page/mods/components/button-group/button-group-xtpl",function(t,e,n,a){return function(t,e,n){var r,i="",o=this.config,l=this,s=o.utils;"undefined"!=typeof a&&a.kissy&&(r=a);var u=s.runBlockCommand,c=s.renderOutput,d=s.getProperty,p=(s.runInlineCommand,s.getPropertyOrRunCommand);i+='<div class="rev-ctl">\n  <label class="feel-ctl-lal">';var f=p(l,t,{},"desc",0,2);i+=c(f,!0),i+=':</label>\n  <ul class="ctl-radio-group" aria-role="radiogroup" aria-label="';var h=p(l,t,{},"desc",0,3);i+=c(h,!0),i+='" tabindex="0">\n    ';var g={},m=[],v=d(l,t,"optionList",0,4);return m.push(v),g.params=m,g.fn=function(t){var e="";e+='\n    <li aria-role="radio" class="ctl-radio-item" data-value="';var n=p(l,t,{},"ctrlId",0,5);e+=c(n,!0),e+='" aria-label="';var a=p(l,t,{},"desc",0,5);e+=c(a,!0),e+='">\n      <span>';var r=p(l,t,{},"desc",0,6);return e+=c(r,!0),e+="</span>\n    </li>\n    "},i+=u(l,t,g,"each",4),i+="\n  </ul>\n</div>"}}),KISSY.add("page/mods/components/button-group/button-group",["node","xtemplate/runtime","./button-group-xtpl"],function(t,e){"use strict";function n(){this._ctor.apply(this,arguments)}var a=e("node").all,r=e("xtemplate/runtime"),i=e("./button-group-xtpl");return KISSY.mix(n.prototype,{_ctor:function(t,e){var n=this;n.el=t,n._options=e;var o=n._options.data;n.el.html(new r(i).render(o.fields)),n.el.delegate("click",".ctl-radio-item",function(t){var e=a(t.currentTarget);e.hasClass("ctl-radio-item")||(e=e.parent(".ctl-radio-item")),e&&n.select(e)}).delegate("keydown",".ctl-radio-group",function(t){var e,r=38===t.keyCode,i=40===t.keyCode;if(r||i){t.preventDefault();var o=a(".ctl-radio-item-checked",n.el);e=o.length?r?o.prev(".ctl-radio-item"):o.next(".ctl-radio-item"):a(".ctl-radio-item",n.el),e&&e.length&&n.select(e)}});var l=o.fields.selectedId;l&&a(".ctl-radio-item",n.el).each(function(t){if(t.attr("data-value")===l)return n.select(t),!1})},select:function(t){var e=a(t);this.setValue(e.attr("data-value")),e.addClass("ctl-radio-item-checked").attr("aria-checked","true"),e.siblings(".ctl-radio-item").removeClass("ctl-radio-item-checked").attr("aria-checked","false")},setValue:function(t){var e=this._options.data;e.fields.selectedId=t,this._options.onUpdate(e)},validate:function(){return null}}),n}),KISSY.add("page/mods/components/components",["node","json","utils/_3rd/sdk","./button-group/button-group"],function(t,e){"use strict";var n=e("node").all,a=e("json"),r=e("utils/_3rd/sdk"),i={buttonGroup:e("./button-group/button-group")},o="component";return{init:function(t,e){var l=n(t);if(l.length){var s=e.data,u=n(e.inputEl);s&&!KISSY.isEmptyObject(s)&&r.use(function(t){t.init({initData:s}),l.each(function(e){var n=e.attr("data-component");if(n){var r=t.getDataByUUID(n);if(r&&!KISSY.isEmptyObject(r)){var l=r.type,s=i[l];s&&e.data(o,new s(e,{data:r,onUpdate:function(e){t.update(e);var n=a.stringify(t.getSubmitData());u.length&&u.val(encodeURIComponent(n))}}))}}})})}},validate:function(t){var e=[];return n(t).each(function(t){var n=t.data(o);if(n){var a=n.validate();a&&e.push({el:t,message:a})}}),e}}}),KISSY.add("page/mods/remark-seller",["node","json","dom","cookie","gallery/local-storage/1.0/","cm/rate-platform/common/","./rate-item","./controls","utils/remark/simple-star","utils/_3rd/login","utils/env/","./components/components"],function(t,e){"use strict";function n(t,e){e||(e=0);var n=l.viewportHeight(),a=l.scrollTop(),r=i(t).offset().top+e;return r>=a&&r<a+n}function a(t){var e=!1,n=!1,a=s.get("_nk_"),o="remark_seller_public_tip"+a,l="remark_seller_force_private_tip"+a;KISSY.each(t,function(t){var a=i(".share-box label",t.el);if(a.length){i("input",a).on("click",function(){c.tooltip.hide(i("label",i(this).closest(".share-box")))});var s=t.getPrivate();u.getItem(o)||e||"0"!==s||(e=!0,r(a[0],'\u516c\u5f00\u8bc4\u8bba\u540e\uff0c\u5176\u4ed6\u6dd8\u53cb\u53ef\u4ee5\u5728\u5b9d\u8d1d\u8be6\u60c5\u9875\u548c\u4f60\u7684<a target="_blank" href="'+S.buyerHome+'">\u4e2a\u4eba\u4e3b\u9875</a>\u770b\u5230\u8fd9\u6761\u8bc4\u8bba',o)),u.getItem(l)||n||"1"!==s||!t.privacyDisabled()||(n=!0,r(a[1],{content:"\u8336\u53f6\u3001\u865a\u62df\u3001\u6210\u4eba\u7c7b\u76ee\u7684\u5b9d\u8d1d\u5f3a\u5236\u533f\u540d",width:160},l))}})}function r(t,e,n){t&&(KISSY.isString(e)&&(e={content:e}),e=KISSY.mix({content:"",placement:"t",width:240,attachPoint:"parent",unsafe:!0,closable:!1,onShow:function(t,e){i(".J_TbRate_DND",t).on("click",function(){c.tooltip.hide(e),u.setItem(n,1)})}},e),e.content+=' <button class="J_TbRate_DND tb-rate-btn type-taobao alt-flat size-xxs" title="\u4e0d\u518d\u63d0\u9192">\u77e5\u9053\u4e86</button>',c.tooltip.show(t,e))}var i=e("node").all,o=e("json"),l=e("dom"),s=e("cookie"),u=e("gallery/local-storage/1.0/"),c=e("cm/rate-platform/common/"),d=e("./rate-item"),p=e("./controls"),f=e("utils/remark/simple-star"),h=e("utils/_3rd/login"),g=e("utils/env/"),m=e("./components/components"),v=".rev-ctl-component",S=g.getInitParams();return{init:function(t){function e(t){var e=s.all("div.submitbox div.msg");return t?(e.length||(e=i('<div class="msg"></div>'),e.insertBefore(s.all("div.submitbox button"))),void KISSY.later(function(){e.html('<p class="error">'+t+"</p>").show()},50)):void e.remove()}var r,l=i(".rate-box"),s=i("#rateListForm"),u=[],g=[],S=[],I=!!t.isFWOrder;l.each(function(e){var n=new d(e,s,t);u.push(n)}),a(u),p.init(),m.init(v,{data:t.componentData,inputEl:s[0].elements.component}),i("ul.stars .rate-stars").each(function(e){var n=e.attr("data-type");g.push(new f(e,{tooltips:n?t.star_tooltip[n]:[],levelText:t.levels}))}),i("ul.o2oshop-stars .rate-stars").each(function(e){var n=new f(e,{tooltips:["\u5f88\u4e0d\u6ee1\u610f","\u4e0d\u6ee1\u610f","\u4e00\u822c","\u6ee1\u610f","\u5f88\u6ee1\u610f"],levelText:t.levels});n.on("change",function(){e.closest(".item-o2oshop-rate").addClass("is-o2o-rated")}),S.push(n)}),r=c.rating.create(".J_o2o_feature_rating"),c.rating.create(".J_TbRate_Rating",{attachMode:"as-is",on:{change:function(t,e,n,a){var r=n.parent().all(".ks-ss-tips");r.length||(r=i('<span class="ks-ss-tips"></span>').insertAfter(n)),r.html("<strong>"+t+" \u5206</strong> - "+a.attr("data-tbrate-tooltip"))}}}),s.on("submit",function(a){var l,d,f=[],b=0,_=0,k=0,x=0;a.halt(),KISSY.each(u,function(t){var e=t.checkForm();e&&f.push({el:t.el,message:e})});var y=p.check();y.length&&(f=f.concat(y));var K=m.validate(v);if(K.length&&(f=f.concat(K)),f.length){var Y=i(f[0].el);return void(Y.length&&!n(Y,-20)&&i(window).animate({scrollTop:Y.offset().top-20},.3,"easeOut",function(){try{Y.getDOMNode().focus()}catch(t){}}))}KISSY.each(u,function(t){t.rateradios&&(k++,null!==t.getRateScore()&&x++),t.dsr&&(b++,t.dsr.index()!==-1&&_++)}),KISSY.each(g,function(t){b++,t.index()!==-1&&_++});var C;if(i(".J_TbRate_Remark_Service").each(function(t){var e=i(t),n=i("input[name=payload]",e),a=i("textarea",e),r=i(".J_TbRate_PicUpload4Svc",e).data("tbRateIdPathMap"),l=[],s={orderId:e.attr("data-order-id"),catId:e.attr("data-cat-id"),scores:KISSY.map(i(".J_TbRate_Rating",t),function(t){var e=i(t).closest("li");return{id:parseInt(e.attr("data-score-id"),10),name:i(".rating-lbl",e).text(),score:parseInt(c.rating.getValue(t),10)}}),images:l,content:a.val()};r&&KISSY.each(r,function(t,e){l.push({id:e,path:t})});var u=[];if(KISSY.some(s.scores,function(t){return!t.score})&&u.push("\u8bf7\u7ed9\u670d\u52a1\u6253\u5206\u54e6\uff0c\u4eb2\uff01"),s.content){var d=parseInt(a.attr("data-minlength"),10)||0,p=parseInt(a.attr("maxlength"),10)||0;d>0&&s.content.length<d?u.push("\u670d\u52a1\u8bc4\u4ef7\u5b57\u6570\u4e0d\u8981\u5c11\u4e8e"+d+"\u4e2a\u5b57\uff01"):p>0&&s.content.length>p&&u.push("\u670d\u52a1\u8bc4\u4ef7\u5b57\u6570\u4e0d\u8981\u591a\u4e8e"+p+"\u4e2a\u5b57\uff01")}!C&&u.length&&(C=u[0]),u.length?(C=C||u[0],n.val("")):n.val(o.stringify(s))}),C)return void e(C);var w=k>0&&0==x,T=b>0&&0==_;if(S.length&&(l=!0,d=!1,KISSY.each(S,function(t){var e=t.index();e!==-1&&(i("#J_o2oShopScore").val(e+1),d=!0)})),I&&T)return void e("\u5fc5\u987b\u6253\u5206\u54e6\uff0c\u4eb2\uff01");if(w&&T||0==k&&T||0==b&&w){if(l){if(!d)return void e("\u60a8\u8fd8\u6ca1\u6709\u8bc4\u4ef7\u7ebf\u4e0b\u95e8\u5e97\u54e6\uff0c\u4eb2\uff01");if(w)return void e("\u8bf7\u586b\u5199\u8bc4\u4ef7\u5185\u5bb9\u54e6\uff0c\u4eb2\uff01")}return void e("\u4f60\u8fd8\u6ca1\u6709\u6dfb\u52a0\u4efb\u4f55\u8bc4\u4ef7\uff0c\u4e0d\u8981\u5077\u61d2\u54e6\uff0c\u4eb2\uff01")}if(l){if(d&&w)return void e("\u8bf7\u586b\u5199\u8bc4\u4ef7\u5185\u5bb9\u54e6\uff0c\u4eb2\uff01");if(!d&&!w)return void e("\u60a8\u8fd8\u6ca1\u6709\u8bc4\u4ef7\u7ebf\u4e0b\u95e8\u5e97\u54e6\uff0c\u4eb2\uff01")}if(r.isInvalid())return e("\u60a8\u8fd8\u6ca1\u6709\u5bf9\u7ebf\u4e0b\u95e8\u5e97\u7684\u5404\u9879\u6307\u6807\u505a\u8bc4\u4ef7\u54e6\uff0c\u4eb2\uff01"),void i(".o2oshop-rate-box").scrollIntoView();if(!(t.isB2C&&b>0&&_<b)||window.confirm("\u4f60\u8fd8\u6709\u672a\u5b8c\u6210\u7684\u8bc4\u5206\uff0c\u786e\u5b9a\u4ee5\u540e\u90fd\u4e0d\u8bc4\u5206\u4e86\uff1f")){var R={},D={};KISSY.each(u,function(t){t.rateradios&&null!==t.getRateScore()&&(R[t.id]=!0)});var j,P,E=i('input[name="component"]');if("undefined"!=typeof SimpleSDK&&E&&window.POICheckers){for(P=0;P<POICheckers.length;P++){if(j=POICheckers[P](),!j.isPass)return void(j.tip&&e(j.msg));j.passNum>0&&(D[j.moreCheckerInfo.orderId]=!0)}for(var O in D)if(!R[O])return void e("\u8bc4\u4ef7\u4e86\u95e8\u5e97\u7684\u5b9d\u8d1d\u5fc5\u987b\u9009\u62e9\u597d\u3001\u4e2d\u3001\u5dee\u8bc4");E.val(encodeURIComponent(o.stringify(SimpleSDK.getData())))}var L=i("button.J_submit_rate",s),J=L.text();e(""),L.prop("disabled",!0).text("\u63d0\u4ea4\u4e2d..."),h.check().then(function(t){var e=s[0].elements._tb_token_;e&&(e.value=t),s[0].submit()},function(){L.text(J).prop("disabled",!1)})}})}}}),KISSY.add("utils/remark/trade-iframe",["node"],function(t,e){"use strict";function n(t){o.attr("height",t)}function a(){o.length&&setTimeout(function t(){var e=i.height();s!==e&&(s=e,n(s)),setTimeout(t,c)},c)}function r(){if(i=l("#page"),!(u>10)){u++;try{if(!parent||!parent.document)throw new Error("domain");if(o=l("#RateIframe",parent.document),!o.length)throw new Error("domain");a()}catch(t){setTimeout(r,50)}}}var i,o,l=e("node").all,s=0,u=0,c=200;return{init:r}}),KISSY.add("utils/goldlog/index",function(){function t(t){var e,n=t.length,a=n+"#"+t.charCodeAt(n-1),r=0,i=a.length;for(e=0;e<i;e++)r=31*r+a.charCodeAt(e);return"H"+r}return function(e){var n=window.goldlog;n&&n.record&&n.record(e,"","",t(e))}}),KISSY.add("utils/remark/lx",["node","promise","io","utils/goldlog/","utils/retcode/"],function(t,e){var n=e("node").all,a=e("promise"),r=e("io"),i=e("utils/goldlog/"),o=e("utils/retcode/");return function(t,e,l){var s=n(t),u=o.retCode("\u662f\u5426\u624b\u6dd8\u65b0\u7528\u6237");s.length&&e&&r({url:"//ferrari.m.taobao.com/novice/GetNoviceUserType.do",dataType:"jsonp",data:{user_id:l}}).then(function(t){return u.success(),KISSY.inArray(parseInt(t[0].result,10),[-1,1,2])},function(){return u.failed(),!0}).then(function(t){var e=o.retCode("\u662f\u5426\u624b\u6dd8\u65b0\u7528\u6237");return t?r({url:"//www.taobao.com/go/rgn/common/stpjlx.php",dataType:"jsonp"}).then(function(t){var n=t[0];return e.success(),n.img&&n.url?n:a.reject(1)},function(){e.failed()}):a.reject(2)}).then(function(t){var a=t.url;n(['<a class="tb-rate-banner-link" href="',t.url+(a.indexOf("?")<0?"?":"&")+(t.param||"id")+"="+e,'" target="_blank">','<img src="',t.img,'" />',"</a>"].join("")).on("click",function(){i("/wap.1616.1002")}).prependTo(s[0]),i("/wap.1616.1001")})}}),KISSY.add("page/init",["node","./mods/remark-seller","./mods/personal-data","utils/remark/trade-iframe","utils/env/","utils/remark/lx"],function(t,e){"use strict";var n=e("node").all,a=e("./mods/remark-seller"),r=e("./mods/personal-data"),i=e("utils/remark/trade-iframe"),o=e("utils/env/"),l=e("utils/remark/lx"),s=o.getInitParams({personalDataURL:"",buyerId:""});window.self!==window.parent&&setTimeout(function(){i.init()},0),a.init(s),r.init({url:s.personalDataURL,userID:s.buyerId}),l(n("form#rateListForm .itemlist")[0],o.getLocationParam("trade_id"),s.buyerId)});
SNS.define(["sns/widget/sharesite.css"],function(){var e=KISSY,s=e.DOM,a=e.Event,t="bound",n="data",c="data-name",o="data-url",r=n+"-id",l=n+"-sign",d={},u=null,h="0",f={SHARE_INFO_URI:"//t.taobao.com/cooperate/preload.htm",GET_SITES_INFO:"//t.taobao.com/cooperate/bindInfo.htm",CHECK_BOUND_URI:"//t.taobao.com/cooperate/connect/check_bound.htm",REM_BIND_URI:"//t.taobao.com/cooperate/setIconStatus.htm?_input_charset=utf-8"},_={tip:'<span class="ts-tip"><i class="i-arrow"></i><span class="tip-content">{{text}}</span></span>',section:'<div class="sns-share-widget-header"><a href="#" class="close J_Close">\u5173\u95ed</a><h3>{{title}}</h3></div><div class="sns-share-widget-body"><div class="sns-share-widget-content {{#if type}} {{type}}{{/if}}">{{content}}</div></div><div class="sns-share-widget-footer"><div class="operate clearfix">{{#each btns}}<a class="{{_ks_value.cls}}" href="#">{{_ks_value.name}}</a>{{/each}}{{#if extra}}{{extra}}{{/if}}</div></div>',sharbar:'<div class="sns-share-app">{{#if batchCheckbox}}<input type="checkbox" class="J_SycMB" {{#if defaultChecked}}checked="checked"{{/if}}><span class="title">{{shareTitle}}\uff1a</span>{{/if}}{{#each apps}}<label class="J_Sapp {{#if _ks_value.sign==\'jianghu\'}}J_JiangHuIcon J_Bounded {{#if defaultChecked}}checked{{#else}}disable{{/if}} {{#else}}  {{#if !(_ks_value.boundurl) && _ks_value.last==\'1\'}} J_Bounded checked {{#elseif !(_ks_value.boundurl) && _ks_value.last==\'0\'}} J_Bounded disable {{#else}} J_BoundApp disable {{/if}}{{/if}}" data-id="{{_ks_value.id}}" data-url="{{_ks_value.boundurl}}" data-name="{{_ks_value.name}}" data-sign="{{_ks_value.sign}}"><i class="i-{{_ks_value.sign}}"></i></label>{{/each}}</div>'},p=SNS.createWidget({configs:{skinType:1,output:"",client_id:"",shareTitle:"\u5206\u4eab\u5230",type:"webpage",key:location.href,batchCheckbox:!1,defaultChecked:!1,isLocalRequest:!1,sitesHiddenName:"shareSites",checkedSites:[],callback:{initCallback:function(){}}},_create:function(){var a=this;a.configs.output=s.get(a.configs.output)?s.get(a.configs.output):a.element,e.use("overlay,template",function(e){a.configs.isLocalRequest?a._bindEvent():a._request()})},_request:function(){var s,a=this;s={type:"webpage"},a.configs.includeSites&&(s.includeSites=a.configs.includeSites),SNS.ajax({url:SNS.normalize(f.GET_SITES_INFO),data:s,type:"get",use:"jsonp",success:function(s){if(s&&"1"==s.status){var t=s.result;t.batchCheckbox=a.configs.batchCheckbox,t.defaultChecked=a.configs.defaultChecked,a._render(e.merge(t,{shareTitle:a.configs.shareTitle}))}}})},_render:function(a){{var t=this;t.configs.output}e.use(KISSY.version.indexOf("1.4")>=0?"gallery/template/1.0/":"template",function(e,n){if(1===t.configs.skinType?s.addClass(l,"sns-site-default"):2===t.configs.skinType&&s.addClass(l,"sns-site-big"),t.configs.checkedSites.length>0){var i=t.configs.checkedSites.substr(1,t.configs.checkedSites.length-2);i.length>0&&(h="-1"==i?h:i)}else{var c=[];e.each(a.apps,function(e){"1"===e.last&&(c.push(e.id),h=c.join(","))})}var o="";t.configs.batchCheckbox&&t.configs.defaultChecked||!t.configs.batchCheckbox?(o=h.split(","),e.each(a.apps,function(e){e.last="0";for(var s=0;s<o.length;s++)e.id!=o[s]||e.boundurl||(e.last="1")})):t.configs.batchCheckbox&&!t.configs.defaultChecked&&e.each(a.apps,function(e){e.last="0"});var r=e.Template(_.sharbar).render(a),l=t.configs.output;s.html(l,r);var d='<input class="J_SiteInfo" type="hidden" name="'+t.configs.sitesHiddenName+'" value="['+o+']" />';r+=d,s.html(l,r),t._trigger("initCallback",a),t._bindEvent()})},_bindEvent:function(){var e=this,t=e.configs.output;a.remove(t,"click"),a.on(t,"click",function(a){var n=a.target;if(SNS.checkLogin(!0)){if(s.parent(n,".J_Sapp")){var i=s.parent(n,1);if(s.hasClass(i,"J_Bounded disable")||s.hasClass(i,"J_Bounded checked")){if(s.hasClass(n,"J_Sapp mouseout")||s.parent(n,".J_JiangHuIcon"))return;s.hasClass(i,"J_Bounded disable")&&(s.get(".J_SycMB",t)&&(s.get(".J_SycMB",t).checked=!0),s.addClass(s.get(".J_JiangHuIcon",t),"checked"),s.removeClass(s.get(".J_JiangHuIcon",t),"disable")),s.toggleClass(i,"disable checked"),e._setIconStatus(t),e._hideOverlay("tip",!1)}s.hasClass(i,"J_BoundApp")&&s.hasClass(i,"disable")&&e._showBoundTip(i,!0),s.get(".J_SiteInfo",t).value=e._returnSiteInfo()}s.hasClass(n,"J_SycMB")&&("checked"==s.attr(n,"checked")?(e._setShareSites(),h=e._getShareSites().id):(h=e._getShareSites().id,e._setShareSites("close")))}else SNS.login(function(){e._request()},!1,!0)})},_bindAjAXEvent:function(e){var t=this,n=t.configs.output;a.on(".sns-share-widget-boundpanel","click",function(a){var i=a.target;s.hasClass(i,"J_Close")&&(a.preventDefault(),d.bound&&d.bound.destroy()),s.hasClass(i,"J_BoundSuccess")&&(a.preventDefault(),t._finishBoundApp(e),s.get(".J_SycMB",n)&&(s.get(".J_SycMB",n).checked=!0),s.addClass(s.get(".J_JiangHuIcon",n),"checked"),s.removeClass(s.get(".J_JiangHuIcon",n),"disable"),t._setIconStatus(n))})},_finishBoundApp:function(e){var a=this,t=e,n=s.attr(t,r);this._checkBound(n,{success:function(){s.removeClass(t,"disable"),s.removeClass(t,"J_BoundApp"),s.addClass(t,"checked"),s.addClass(t,"J_Bounded"),a._hideOverlay("bound")},failure:function(){a._hideOverlay("bound"),SNS.alert("\u7ed1\u5b9a\u5931\u8d25,\u8bf7\u91cd\u65b0\u7ed1\u5b9a,\u5982\u679c\u95ee\u9898\u4f9d\u65e7\u5b58\u5728,\u53ef\u80fd\u662f\u76f8\u5173\u5e73\u53f0\u7e41\u5fd9,\u8bf7\u7a0d\u540e\u91cd\u8bd5!")}})},_checkBound:function(e,s){SNS.ajax({url:SNS.normalize(f.CHECK_BOUND_URI),data:{partner_id:e},type:"get",use:"jsonp",success:function(e){e&&"1"==e.bounded?s&&s.success&&s.success():s&&s.failure&&s.failure()}})},_showBoundTip:function(e){var a=this;a._hideOverlay("boundGuide"),a._renderMessage({title:"\u5e10\u53f7\u7ed1\u5b9a",btns:[{cls:"ts-continue J_BoundSuccess bound-success",name:"\u5b8c\u6210\u7ed1\u5b9a"}],content:"\u524d\u5f80<em>"+s.attr(e,c)+'</em>\u8fde\u63a5\u5e10\u53f7, \u6dd8\u5b9d\u7f51\u4f1a\u786e\u4fdd\u4f60\u7684\u5e10\u53f7\u5b89\u5168, \u8bf7\u653e\u5fc3\u8fde\u63a5...<div class="warn-message">\u957f\u65f6\u95f4\u4e0d\u5206\u4eab\u7ed9'+s.attr(e,c)+"\uff0c\u7ed1\u5b9a\u4f1a\u5931\u6548\u54e6</div>",type:s.attr(e,l)+"-message",extra:'<span class="extra">\u8fd8\u672a\u5b8c\u6210? \u8bf7<a href="'+s.attr(e,o)+'" target="_blank">\u91cd\u65b0\u8fde\u63a5</a></span>',name:"bound"},"",e),s.hasClass(e,"J_BoundApp")&&s.hasClass(e,"disable")&&a._openBoundUrl(e)},_renderMessage:function(e,s,a){var n=this,i=s||{name:t},c=i.name,o=n._renderSection(c,e,"boundpanel",i);o.show(),o.center(),n._bindAjAXEvent(a)},_renderSection:function(s,a,t,n){var i,c=e.merge({elCls:"sns-share-widget-"+(t||EMPTY),content:e.Template(_.section).render(a)},n||{});return i=d[s]=new e.Overlay(c)},_openBoundUrl:function(e){window.open(s.attr(e,o))},_hideOverlay:function(e,s){var a=u,t=d[e];a&&(clearTimeout(a),u=null),t&&(s?t.destroy():t.hide())},_returnSiteInfo:function(){var e=this,s=e._getShareSites(),a=s.id.join(",");return a&&(a="["+a+"]"),a},_createParam:function(e){var s="",a=s;for(var t in e)e[t].length>0&&(a+=',"'+t+'":["'+e[t].join('","')+'"]');return s!==a&&(a="{"+a.substring(1)+"}"),a},_getShareSites:function(){var e,a,t=this,n={sign:[],id:[]},i=t.configs.output,c=s.query(".J_Sapp",i);for(e=0,a=c.length;a>e;e++){var o=c[e];s.hasClass(o,"checked")&&(n.sign.push(s.attr(o,l)),n.id.push(s.attr(o,r)))}return n},_setShareSites:function(a){var t=this,n=t.configs.output,i=s.query(".J_Sapp",n),c=i.length;if("close"==a){s.get(".J_SiteInfo",n).value="[]";for(var o=0;c>o;o++){if(s.hasClass(i[o],"J_BoundApp"))return;s.addClass(i[o],"disable"),s.removeClass(i[o],"checked")}}else{siteInfoArr=e.isString(h)?h.split(","):h,s.get(".J_SiteInfo",n).value="["+h+"]";for(var r=0;r<siteInfoArr.length;r++)for(var o=0;c>o;o++)if(s.attr(i[o],"data-id")==siteInfoArr[r]){if(s.hasClass(i[o],"J_BoundApp"))return;s.addClass(i[o],"checked"),s.removeClass(i[o],"disable")}}},_setIconStatus:function(a){e.later(function(){var e=[],t=s.query(".J_Sapp",a);for(i=0,len=t.length;i<len;i++){var n=t[i];s.hasClass(n,"checked")&&e.push(s.attr(n,r))}SNS.ajax({url:SNS.normalize(f.REM_BIND_URI),data:{siteIds:e},type:"get",use:"jsonp",success:function(){}})},0)}});return p});